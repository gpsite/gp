<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>George Pickens</title>
<link rel="icon" type="image/gif" href="https://gpsite.github.io/gp/img/logo.png">
<style>
:root {
  --bg:#000;
  --chip:#222428;
  --chip-hover:#2b2e33;
  --icon-border:#000;
  --blue:#74aef6;
  --green:#7ed321;
  --yellow:#f8e71c;
  --red:#ff3b2f;
}

html, body {
  height: 100%;
  margin: 0;
}

body {
  background: var(--bg);
  color: #fff;
  font-family: "Segoe UI", sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  padding-bottom: 90px; /* extra space at bottom */
}

#bg-canvas, .bubble-container {
  position: fixed;
  inset: 0;
  z-index: 0;
}

header {
  margin-top: 20px;
  margin-bottom: 30px;
  text-align: center;
  z-index: 1;
}

header img {
  width: 200px;
  height: auto;
  border-radius: 20px;
}

/* Row container */
.main-row {
  width: 100%;
  max-width: 1250px;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 40px;
  z-index: 1;
}

/* MENU */
nav.menu {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  max-width: 460px;
  margin: 0 auto 40px;
  z-index: 1;
}

.btn {
  display: flex;
  align-items: center;
  gap: 18px;
  text-decoration: none;
  color: #fff;
  background: var(--chip);
  padding: 18px 24px;
  border-radius: 16px;
  font-size: 26px;
  letter-spacing: 2px;
  transition: transform .1s ease, background .2s ease;
}
.btn:hover {
  background: var(--chip-hover);
  transform: translateY(-2px);
}

.quad {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 4px;
  width: 36px;
  height: 36px;
  padding: 4px;
  background: #222428;
  border-radius: 8px;
  box-shadow: 0 0 0 2px var(--icon-border) inset;
}

.sq { border-radius: 4px; }
.sq.blue { background: var(--blue); }
.sq.green { background: var(--green); }
.sq.yellow { background: var(--yellow); }
.sq.red { background: var(--red); }

.announcements {
  background: var(--chip);
  padding: 20px 24px;
  border-radius: 16px;
  width: 100%;
  max-width: 680px;
  overflow: hidden;
  line-height: 1.5;
  z-index: 1;
  display: flex;
  flex-direction: column;
}

.announcements h2 {
  margin: 0 0 12px 0;
  font-size: 24px;
}

.announcements-content {
  font-size: 16px; /* base size (will be adjusted via JS) */
  line-height: 1.5;
  flex: 1 1 auto;
  overflow-y: auto;
  padding-right: 4px; /* small space for scrollbar clearance */
  scrollbar-width: thin;
}

.announcements-content ul {
  margin: 0;
  padding-left: 22px;
}

.announcements-content li {
  margin-bottom: 12px;
}

/* Two-column layout for wider screens */
@media (min-width: 900px) {
  .main-row {
    flex-direction: row;
    align-items: stretch; /* ensures equal height columns */
    justify-content: center;
  }
  .announcements {
    flex: 1 1 55%;
  }
  nav.menu {
    flex: 0 0 420px;
    margin: 0;
  }
  .announcements-content {
    overflow-y: auto;
  }
}

/* Mobile adjustments */
@media(max-width: 600px) {
  .btn {
    font-size: 20px;
    padding: 14px 18px;
  }
  header img {
    width: 150px;
  }
}

/* Optional nicer thin scrollbar (webkit) */
.announcements-content::-webkit-scrollbar {
  width: 8px;
}
.announcements-content::-webkit-scrollbar-track {
  background: #1a1c1f;
  border-radius: 8px;
}
.announcements-content::-webkit-scrollbar-thumb {
  background: #3a3d42;
  border-radius: 8px;
}
.announcements-content::-webkit-scrollbar-thumb:hover {
  background: #4a4d52;
}
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div class="bubble-container" id="bubble-container"></div>

<header>
  <img src="https://gpsite.github.io/gp/img/logo.png" alt="GP Logo">
</header>

<div class="main-row">
  <section class="announcements" id="announcementsBox">
    <h2>Announcements</h2>
    <div class="announcements-content" id="announcementsContent">
      <!-- Fallback content (will be replaced when Google Sheets loads) -->
      <ul>
        <li><b>FAILED TO LOAD ANNOUNCEMENTS DATA</b></li>
      </ul>
    </div>
  </section>

  <nav class="menu" id="buttonsColumn">
    <a class="btn" href="pages/games/index.html">
      <span class="quad">
        <span class="sq blue"></span><span class="sq green"></span>
        <span class="sq yellow"></span><span class="sq red"></span>
      </span>
      <span>GAMES</span>
    </a>
    <a class="btn" href="pages/movies/index.html">
      <span class="quad">
        <span class="sq blue"></span><span class="sq green"></span>
        <span class="sq yellow"></span><span class="sq red"></span>
      </span>
      <span>MOVIES</span>
    </a>
    <a class="btn" href="pages/chat/index.html">
      <span class="quad">
        <span class="sq blue"></span><span class="sq green"></span>
        <span class="sq yellow"></span><span class="sq red"></span>
      </span>
      <span>CHAT (BETA)</span>
    </a>
    <a class="btn" href="pages/ai/index.html">
      <span class="quad">
        <span class="sq blue"></span><span class="sq green"></span>
        <span class="sq yellow"></span><span class="sq red"></span>
      </span>
      <span>GP-CLANKER</span>
    </a>
  </nav>
</div>

<script src="scripts/starry-background.js"></script>

<script>
  // Load announcements from Google Sheets and inject into the list, with simple bold + color markup.
  (function() {
    // Your provided endpoint (home sheet/range). Consider restricting this API key to your domain in Google Cloud Console.
    const SHEETS_ENDPOINT = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/home?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';

      if (typeof setupStarryBackground === 'function') {
        setupStarryBackground();
      }

    const contentEl = document.getElementById('announcementsContent');
    if (!contentEl) return;

    // Create a UL we will fully control
    let ul = contentEl.querySelector('ul');
    if (!ul) {
      ul = document.createElement('ul');
      contentEl.innerHTML = '';
      contentEl.appendChild(ul);
    }

    // Allowed CSS named colors (case-insensitive)
    const ALLOWED_NAMED_COLORS = new Set([
      'black','white','gray','grey','silver','lightgray','darkgray',
      'red','crimson','maroon','orange','coral','tomato',
      'yellow','gold','khaki',
      'green','lime','olive','seagreen','teal',
      'blue','navy','royalblue','dodgerblue','deepskyblue','skyblue',
      'indigo','violet','purple','magenta','fuchsia','pink','hotpink',
      'cyan','aqua','turquoise'
    ]);

    function normalizeColor(input) {
      if (!input) return null;
      const c = String(input).trim().toLowerCase();
      // Accept #rgb or #rrggbb hex
      if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(c)) return c;
      // Accept a whitelist of named colors
      if (ALLOWED_NAMED_COLORS.has(c)) return c;
      return null; // reject everything else
    }

    // Turn limited markup into DOM nodes safely (no innerHTML from user data).
    // Supported:
    // - **bold** or [b]bold[/b]
    // - [color=red]text[/color] or [color=#ff8800]text[/color]
    // Can be combined/nested.
    function nodesFromMarkup(text) {
      const frag = document.createDocumentFragment();
      let i = 0;
      let bold = false;
      let color = null;
      const colorStack = [];
      let buf = '';

      function flush() {
        if (!buf) return;
        let node;
        if (color && bold) {
          node = document.createElement('b');
          node.style.color = color;
          node.textContent = buf;
        } else if (color) {
          node = document.createElement('span');
          node.style.color = color;
          node.textContent = buf;
        } else if (bold) {
          node = document.createElement('b');
          node.textContent = buf;
        } else {
          node = document.createTextNode(buf);
        }
        frag.appendChild(node);
        buf = '';
      }

      while (i < text.length) {
        // ** toggle bold
        if (text.startsWith('**', i)) {
          flush();
          bold = !bold;
          i += 2;
          continue;
        }
        // [b] on
        if (text.startsWith('[b]', i)) {
          flush();
          bold = true;
          i += 3;
          continue;
        }
        // [/b] off
        if (text.startsWith('[/b]', i)) {
          flush();
          bold = false;
          i += 4;
          continue;
        }
        // [color=...] start
        if (text.startsWith('[color=', i)) {
          const endBracket = text.indexOf(']', i + 7);
          if (endBracket !== -1) {
            const raw = text.slice(i + 7, endBracket);
            const ok = normalizeColor(raw);
            flush();
            // push current color and set new one if valid (ignore invalid)
            colorStack.push(color);
            color = ok !== null ? ok : color;
            i = endBracket + 1;
            continue;
          }
        }
        // [/color] end
        if (text.startsWith('[/color]', i)) {
          flush();
          color = colorStack.length ? colorStack.pop() : null;
          i += 8;
          continue;
        }

        // default: add one character
        buf += text[i];
        i++;
      }

      flush();
      return frag;
    }

    function render(items) {
      ul.innerHTML = '';
      for (const raw of items) {
        const text = String(raw || '').trim();
        if (!text) continue;
        const li = document.createElement('li');
        li.appendChild(nodesFromMarkup(text));
        ul.appendChild(li);
      }
    }

    async function fetchAnnouncements() {
      try {
        const res = await fetch(SHEETS_ENDPOINT + '&t=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        // data.values is an array of rows. We use the first column of each row.
        const rows = Array.isArray(data.values) ? data.values : [];
        // Flatten first column, skip blank rows and a header that looks like "Announcements"
        const items = rows
          .map(r => (r && r.length ? r[0] : ''))
          .map(v => (v == null ? '' : String(v)))
          .map(v => v.trim())
          .filter(v => v.length > 0 && !/^announcements?$/i.test(v));

        if (items.length) {
          render(items);
        } else {
          console.warn('No announcement items found in sheet.');
        }
      } catch (err) {
        console.error('Failed to load announcements from Google Sheets:', err);
        // Keep existing content as fallback
      }
    }

    // Initial load and periodic refresh
    fetchAnnouncements();
    // Refresh every 5 minutes (adjust as desired)
    setInterval(fetchAnnouncements, 5 * 60 * 1000);
  })();
</script>

</body>
</html>