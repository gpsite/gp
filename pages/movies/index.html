<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Movie Catalog - GP</title>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://gpsite.github.io/gp/img/logo.png">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        :root {
            --primary: #003594;
            --bg: #141414;
            --text: #e5e5e5;
            --card-bg: #1f1f1f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            /* Moved search bar over */
            padding: 15px 4%;
            z-index: 1000;
            transition: background 0.3s ease;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
        }

        .navbar.scrolled {
            background: #141414;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            margin-right: 30px;
        }



        /* Search */
        .search-container {
            display: flex;
            align-items: center;
            position: relative;
        }

        .search-icon {
            font-size: 16px;
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1002;
            color: #aaa;
            pointer-events: none;
        }

        .search-input {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            padding: 10px 15px 10px 40px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            width: 300px;
            opacity: 1;
            border-radius: 20px;
            transition: background 0.3s, border 0.3s;
        }

        .search-input:focus {
            background: rgba(0, 0, 0, 0.8);
            border-color: #fff;
        }

        /* Hero */
        .hero {
            height: 80vh;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 4%;
        }

        .hero::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, #141414 10%, transparent 100%),
                linear-gradient(to right, #141414 30%, transparent 100%);
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 500px;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            line-height: 1.1;
        }

        /* Loading Pulse */
        .loading-pulse {
            animation: pulse 1.5s infinite;
            opacity: 0.7;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
                transform: scale(0.98);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.02);
            }

            100% {
                opacity: 0.4;
                transform: scale(0.98);
            }
        }

        .hero-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            margin-bottom: 20px;
            color: #a3a3a3;
        }

        .hero-desc {
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 25px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .btn-primary {
            background-color: #fff;
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        /* Movie Grid */
        .content {
            padding: 40px 4%;
            margin-top: -100px;
            position: relative;
            z-index: 10;
        }

        .grid-header {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .movie-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            /* Tighter gap */
        }

        .movie-card {
            position: relative;
            transition: transform 0.3s;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            background: var(--card-bg);
            aspect-ratio: 2/3;
        }

        .movie-card:hover {
            transform: scale(1.05);
            z-index: 20;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        }

        .movie-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .movie-info-mini {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px 10px 10px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .movie-card:hover .movie-info-mini {
            opacity: 1;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* Darker backdrop */
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .overlay.active {
            opacity: 1;
        }

        .overlay-content {
            width: 90%;
            max-width: 1100px;
            height: 90vh;
            background: #181818;
            border-radius: 8px;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
        }

        /* Scrollbar for overlay */
        .overlay-content::-webkit-scrollbar {
            width: 8px;
        }

        .overlay-content::-webkit-scrollbar-track {
            background: #181818;
        }

        .overlay-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .video-wrapper {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            flex-shrink: 0;
            position: relative;
        }

        .video-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: relative;
            z-index: 2;
        }

        .video-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #000;
            z-index: 1;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader-text {
            color: #fff;
            font-size: 14px;
            letter-spacing: 1px;
            text-transform: uppercase;
            opacity: 0.8;
            font-weight: 500;
        }

        .overlay-details {
            padding: 30px;
            flex-grow: 1;
        }

        .overlay-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .overlay-title {
            font-size: 32px;
            font-weight: 700;
        }

        .overlay-meta {
            color: #aaa;
            margin: 10px 0;
            font-size: 14px;
        }

        .overlay-actions {
            display: flex;
            gap: 15px;
        }

        .btn-icon {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        /* TV Panel Styles */
        .tv-panel {
            margin-top: 30px;
            background: #222;
            padding: 20px;
            border-radius: 8px;
        }

        .tv-panel h3 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #ddd;
        }

        .season-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .season-tab {
            background: #333;
            border: none;
            color: #aaa;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }

        .season-tab.active {
            background: #fff;
            color: #000;
            font-weight: 600;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
        }

        .episode-btn {
            background: #333;
            border: none;
            color: #fff;
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .episode-btn:hover {
            background: #444;
        }

        .episode-btn.active {
            background: var(--primary);
        }

        /* Related / Sequels */
        .related-section {
            margin-top: 40px;
        }

        .related-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }

        .related-card {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .related-card:hover {
            opacity: 0.8;
        }

        .related-card img {
            width: 100%;
            border-radius: 4px;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }

            .navbar {
                padding: 15px 20px;
            }

            .overlay-content {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <a href="#" class="logo" onclick="resetHome()">GEORGE PICKENS</a>

        <div class="search-container" id="searchContainer">
            <i class="fa fa-search search-icon" id="searchIcon"></i>
            <input type="text" class="search-input" id="searchInput" placeholder="Titles, movies, shows, etc...">
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero" id="hero">
        <div class="hero-content">
            <h1 class="hero-title" id="heroTitle">Loading...</h1>
            <div class="hero-meta" id="heroMeta">
                <!-- Meta info will be injected here -->
            </div>
            <p class="hero-desc" id="heroDesc">
                <!-- Desc will be injected here -->
            </p>
            <div id="heroActions">
                <button class="btn-primary" id="heroPlayBtn"><i class="fa fa-play"></i> Play</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="content">
        <h2 class="grid-header" id="gridTitle">Featured</h2>
        <div class="movie-grid" id="movieGrid">
            <!-- Movies injected here -->
        </div>
    </main>

    <!-- Overlay -->
    <div class="overlay" id="overlay">
        <div class="overlay-content">
            <div class="video-wrapper" id="videoWrapper">
                <div class="video-loader" id="videoLoader">
                    <div class="spinner"></div>
                    <div class="loader-text">George Pickens</div>
                </div>
                <div id="videoContainer" style="width:100%; height:100%;"></div>
            </div>
            <div class="overlay-details">
                <div class="overlay-header">
                    <div>
                        <h2 class="overlay-title" id="overlayTitle">Title</h2>
                        <div class="overlay-meta" id="overlayEpisodeInfo"
                            style="display:none; color: var(--primary); font-weight:600;"></div>
                    </div>
                    <div class="overlay-actions">
                        <button class="btn-icon" onclick="closeOverlay()"><i class="fa fa-times"></i></button>
                    </div>
                </div>
                <p id="overlayDesc" style="color:#ddd; line-height:1.6;"></p>

                <!-- TV Panel -->
                <div id="tvPanel" class="tv-panel" style="display:none;">
                    <h3>Episodes</h3>
                    <div class="season-tabs" id="seasonTabs">
                        <!-- S1, S2... -->
                    </div>
                    <div class="episode-grid" id="episodeGrid">
                        <!-- E1, E2... -->
                    </div>
                </div>

                <!-- Related -->
                <div id="relatedSection" class="related-section" style="display:none;">
                    <h3 class="related-title">Other</h3>
                    <div class="related-grid" id="relatedGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <script>
        const CONFIG_SHEET_URL = "https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/movies?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M";

        let KINO_SEARCH_BASE = "";
        let KINO_POSTER_BASE = "";
        let PUBUP_BASE = "";
        let TVMAZE_API = "";

        async function fetchConfig() {
            try {
                console.log("Syncing configuration from Google Sheets...");
                const res = await fetch(CONFIG_SHEET_URL);
                const data = await res.json();

                if (data && data.values) {
                    data.values.slice(1).forEach((row) => {
                        const key = row[0] ? row[0].toString().trim() : null;
                        const value = row[1] ? row[1].toString().trim() : null;

                        if (!key || !value) return;

                        // Only Swap URLs
                        if (key === 'KINO_SEARCH_BASE') KINO_SEARCH_BASE = value;
                        else if (key === 'KINO_POSTER_BASE') {
                            // Safety check: Remove /search or /searchh if present in the poster URL
                            KINO_POSTER_BASE = value.replace(/\/searchh?$/, '');
                        }
                        else if (key === 'PUBUP_BASE') PUBUP_BASE = value;
                        else if (key === 'TVMAZE_API') TVMAZE_API = value;
                    });

                    console.log("Config Synchronized:", { KINO_SEARCH_BASE, KINO_POSTER_BASE, PUBUP_BASE, TVMAZE_API });
                }
            } catch (err) {
                console.error("Critical: Failed to sync remote config", err);
                alert("Critical: Could not load configuration from the cloud. The site may not function correctly.");
            }
        }

        // Cache for TV metadata to avoid repeated fetching
        let tvCache = {};

        // --- Manual Curated List (Original) ---
        const MANUAL_LIST = [
            // Movies (20)
            "Inception", "The Dark Knight", "Interstellar", "The Shawshank Redemption", "The Godfather", "The Godfather Part II", "Pulp Fiction", "Fight Club", "Forrest Gump", "The Matrix",
            "Breaking Bad", "The Lord of the Rings: The Fellowship of the Ring", "The Lord of the Rings: The Two Towers", "The Lord of the Rings: The Return of the King", "The Empire Strikes Back", "Star Wars", "The Prestige", "Gladiator", "The Social Network", "The Departed",
            "The Silence of the Lambs", "Saving Private Ryan", "The Green Mile", "Se7en", "Parasite", "Whiplash", "Django Unchained", "The Wolf of Wall Street", "Avengers: Infinity War", "Avengers: Endgame",
            "Game of Thrones", "The Sopranos", "The Wire", "Better Call Saul", "Stranger Things", "The Truman Show", "Jurassic Park", "Back to the Future", "The Lion King", "Toy Story",
            "Blade Runner 2049", "Blade Runner", "Alien", "Aliens", "The Terminator", "Terminator 2: Judgment Day", "Mad Max: Fury Road", "The Incredibles", "Spider-Man: Into the Spider-Verse", "Logan",
            "The Dark Knight Rises", "Batman Begins", "Joker", "No Country for Old Men", "There Will Be Blood", "The Big Lebowski", "Goodfellas", "Casino", "The Irishman", "Heat",
            "Shutter Island", "The Sixth Sense", "The Usual Suspects", "A Clockwork Orange", "2001: A Space Odyssey", "Apocalypse Now", "Full Metal Jacket", "The Shining", "Dr. Strangelove", "Monty Python and the Holy Grail",
            "Black Mirror", "Chernobyl", "The Mandalorian", "Arcane", "Attack on Titan", "Narcos", "House of the Dragon", "The Boys", "Rick and Morty", "Westworld"
        ];

        // State
        let allMovies = [];
        let currentMovie = null;
        let currentSeason = 1;
        let currentEpisode = 1;

        // DOM Elements
        const navbar = document.getElementById('navbar');
        const hero = document.getElementById('hero');
        const movieGrid = document.getElementById('movieGrid');
        const overlay = document.getElementById('overlay');
        const searchInput = document.getElementById('searchInput');
        const searchContainer = document.getElementById('searchContainer');
        const heroTitle = document.getElementById('heroTitle');

        // --- Helpers ---
        function posterUrl(path) {
            return path ? KINO_POSTER_BASE + path : 'https://via.placeholder.com/300x450?text=No+Poster';
        }

        function buildDirectUrl(id, type, s = 1, e = 1) {
            if (type === 'tv' || type === 'series') {
                return `https://player.videasy.net/tv/${id}/${s}/${e}?nextEpisode=true&autoplayNextEpisode=true&episodeSelector=true&overlay=true&color=003594`;
            }
            return `https://player.videasy.net/movie/${id}?nextEpisode=true&autoplayNextEpisode=true&episodeSelector=true&overlay=true&color=003594`;
        }

        function deduplicate(results, query = "") {
            if (!results || results.length === 0) return [];
            const trash = ["making of", "documentary", "behind the scenes", "challenge of", "special features", "odyssey", "collection", "soundtrack"];
            const q = query.toLowerCase().replace(/\s+/g, '');
            const seenIds = new Set();
            const seenTitles = new Set();

            // Sort by rating desc
            results.sort((a, b) => (b.rating || 0) - (a.rating || 0));

            return results.filter(m => {
                if (!m || !m.id) return false;
                if (seenIds.has(m.id)) return false;

                const t = m.title.toLowerCase();
                const tNoSpace = t.replace(/\s+/g, '');

                // Always keep exact match or match without spaces
                if (q && (tNoSpace === q || tNoSpace.includes(q))) {
                    seenIds.add(m.id);
                    seenTitles.add(t);
                    return true;
                }

                // Filter trash keywords unless search matches them
                if (trash.some(tk => t.includes(tk)) && !q.includes(tk.replace(/\s+/g, ''))) return false;

                // Simple title deduplication
                if (seenTitles.has(t)) return false;

                seenIds.add(m.id);
                seenTitles.add(t);

                return true;
            });
        }

        function escapeHtml(s) {
            return String(s || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }



        // --- Fetch ---
        async function fetchTvDetails(title) {
            if (tvCache[title]) return tvCache[title];

            try {
                // Fetch show details + episodes
                const res = await fetch(`${TVMAZE_API}?q=${encodeURIComponent(title)}&embed=episodes`);
                if (!res.ok) return null;
                const data = await res.json();

                if (data && data._embedded && data._embedded.episodes) {
                    const episodes = data._embedded.episodes;
                    const seasons = new Set(episodes.map(e => e.season));
                    const maxSeason = Math.max(...seasons);

                    // Count episodes per season
                    const seasonCounts = {};
                    episodes.forEach(e => {
                        if (!seasonCounts[e.season]) seasonCounts[e.season] = 0;
                        seasonCounts[e.season]++;
                    });

                    const meta = { totalSeasons: maxSeason, seasonCounts };
                    tvCache[title] = meta;
                    return meta;
                }
            } catch (e) {
                console.warn("TVMaze fetch failed", e);
            }
            return null;
        }

        async function fetchMovie(title) {
            try {
                const url = new URL(KINO_SEARCH_BASE);
                url.searchParams.set("q", title);
                const res = await fetch(url);
                if (!res.ok) return null;
                const data = await res.json();
                if (data && data.results && data.results.length > 0) {
                    // Filter: Poster, Overview, Rating > 4
                    let valid = data.results.filter(m => m.poster && m.overview && m.rating > 4);

                    if (valid.length === 0) return null;

                    // Prefer EXACT match first
                    const exact = valid.find(v => v.title.toLowerCase() === title.toLowerCase());
                    if (exact) return exact;

                    // Sort by rating
                    valid.sort((a, b) => b.rating - a.rating);

                    // Return the best rated match
                    return valid[0];
                }
                return null;
            } catch (err) {
                console.warn(`Failed to fetch ${title}`, err);
                return null;
            }
        }

        async function init() {
            // Fetch remote config first
            await fetchConfig();

            // Loading State
            heroTitle.classList.add('loading-pulse');
            heroTitle.textContent = "Loading Library...";

            // Parallel Fetch
            const promises = MANUAL_LIST.map(title => fetchMovie(title));
            const results = await Promise.all(promises);

            // Filter nulls and map properties
            allMovies = results.filter(m => m).map(m => ({
                id: m.id,
                title: m.title,
                titleNoSpace: m.title.toLowerCase().replace(/\s+/g, ''),
                original_title: m.original_title,
                overview: m.overview,
                date: m.date,
                poster: m.poster,
                rating: m.rating,
                type: m.type || 'movie'
            }));

            // Remove loading
            heroTitle.classList.remove('loading-pulse');

            if (allMovies.length > 0) {
                setupHero(allMovies);
                renderGrid(allMovies);
                document.getElementById('gridTitle').textContent = "Featured";
            } else {
                heroTitle.textContent = "Failed to Load";
            }
        }

        // --- UI Logic ---
        function setupHero(movies) {
            if (!movies.length) return;
            // Pick a random movie from the list
            const featured = movies[Math.floor(Math.random() * movies.length)];

            heroTitle.textContent = featured.title;
            document.getElementById('heroDesc').textContent = featured.overview;

            // Meta
            const meta = document.getElementById('heroMeta');
            meta.innerHTML = `
                <span>${featured.date?.split('-')[0] || 'N/A'}</span>
                <span>â€¢</span>
                <span><i class="fa fa-star" style="color:var(--primary)"></i> ${featured.rating || 'N/A'}</span>
            `;

            const bgUrl = posterUrl(featured.poster);
            hero.style.backgroundImage = `url('${bgUrl}')`;

            // Play Button
            document.getElementById('heroPlayBtn').onclick = () => openOverlay(featured);
        }

        function renderGrid(movies) {
            movieGrid.innerHTML = '';
            movies.forEach(m => {
                const el = document.createElement('div');
                el.className = 'movie-card';
                el.innerHTML = `
                    <img src="${posterUrl(m.poster)}" class="poster" loading="lazy" alt="${escapeHtml(m.title)}">
                    <div class="movie-info-mini">
                        <div>${escapeHtml(m.title)}</div>
                        <div style="font-size:12px; opacity:0.7">${m.date?.split('-')[0] || ''}</div>
                    </div>
                `;
                el.onclick = () => openOverlay(m);
                movieGrid.appendChild(el);
            });
        }



        // --- Real-time Search ---
        let searchDebounce;
        searchInput.addEventListener('input', (e) => {
            const q = e.target.value.trim();
            clearTimeout(searchDebounce);

            if (!q) {
                renderGrid(allMovies);
                document.getElementById('gridTitle').textContent = "Featured";
                return;
            }

            searchDebounce = setTimeout(async () => {
                document.getElementById('gridTitle').textContent = `Searching...`;

                try {
                    // 1. Local Fuzzy Search
                    let localMatches = [];
                    if (window.Fuse) {
                        const fuse = new Fuse(allMovies, {
                            keys: [
                                { name: 'title', weight: 0.7 },
                                { name: 'titleNoSpace', weight: 0.5 },
                                { name: 'original_title', weight: 0.3 }
                            ],
                            threshold: 0.4,
                            distance: 100,
                            includeScore: true
                        });
                        localMatches = fuse.search(q).map(r => r.item);
                    }

                    // 2. API Search
                    const url = new URL(KINO_SEARCH_BASE);
                    url.searchParams.set("q", q);
                    const res = await fetch(url);
                    const data = await res.json();

                    let apiMatches = [];
                    if (data && data.results && data.results.length > 0) {
                        apiMatches = data.results.map(m => ({
                            id: m.id,
                            title: m.title,
                            titleNoSpace: m.title.toLowerCase().replace(/\s+/g, ''),
                            overview: m.overview,
                            date: m.date,
                            poster: m.poster,
                            rating: m.rating,
                            type: m.type || 'movie'
                        })).filter(m => m.poster && m.overview && m.rating > 1.5);
                    }

                    // Combined Pool
                    const pool = [...localMatches, ...apiMatches];
                    const combined = deduplicate(pool, q);

                    // Re-rank by relevance using Fuse if possible
                    let finalResults = combined;
                    if (window.Fuse && combined.length > 0) {
                        const scorer = new Fuse(combined, {
                            keys: [
                                { name: 'title', weight: 0.8 },
                                { name: 'titleNoSpace', weight: 0.5 },
                                { name: 'original_title', weight: 0.2 }
                            ],
                            threshold: 0.4,
                            distance: 100
                        });
                        const fuzzyHits = scorer.search(q);
                        if (fuzzyHits.length > 0) {
                            finalResults = fuzzyHits.map(r => r.item);

                            // Add back anything that was in 'combined' but missed by fuzzy (to be safe)
                            const HitIds = new Set(finalResults.map(m => m.id));
                            combined.forEach(m => {
                                if (!HitIds.has(m.id)) finalResults.push(m);
                            });
                        }
                    }

                    if (finalResults.length > 0) {
                        renderGrid(finalResults);
                        document.getElementById('gridTitle').textContent = `Results for "${q}"`;
                    } else {
                        document.getElementById('gridTitle').textContent = `No results found for "${q}"`;
                        movieGrid.innerHTML = '<div style="color:#aaa; padding:20px;">Try searching for a different title.</div>';
                    }
                } catch (e) {
                    console.error("Search failed", e);
                }
            }, 300);
        });




        // --- Overlay & Player ---
        async function openOverlay(movie) {
            currentMovie = movie;

            // Simple heuristic to detect TV
            const isTV = (movie.type === 'tv' || movie.type === 'series');

            // Reset state
            currentSeason = 1;
            currentEpisode = 1;

            // Update Info
            document.getElementById('overlayTitle').textContent = movie.title;
            document.getElementById('overlayDesc').textContent = movie.overview;
            const epInfo = document.getElementById('overlayEpisodeInfo');

            // --- TV Panel Logic ---
            const tvPanel = document.getElementById('tvPanel');
            if (isTV) {
                tvPanel.style.display = 'block';
                epInfo.style.display = 'block';

                // Show loading state for controls
                document.getElementById('seasonTabs').innerHTML = '<span style="color:#aaa; font-size:12px;">Loading info...</span>';
                document.getElementById('episodeGrid').innerHTML = '';

                // Fetch real metadata
                const meta = await fetchTvDetails(movie.title);

                // Render controls with metadata (or defaults if failed)
                renderTvControls(meta);

                updateEpInfo();
            } else {
                tvPanel.style.display = 'none';
                epInfo.style.display = 'none';
            }

            // --- Sequels / Related Logic ---
            const relatedSection = document.getElementById('relatedSection');
            const relatedGrid = document.getElementById('relatedGrid');
            relatedGrid.innerHTML = '';

            // Smarter Related Search:
            // 1. Extract keywords (handle colons for franchises like "Avengers:")
            // 2. Search API
            // 3. Filter strict & Sort by rating
            try {
                let keywords = movie.title;

                // If title contains ':', split and take first part (e.g. "Avengers: Endgame" -> "Avengers")
                if (movie.title.includes(':')) {
                    keywords = movie.title.split(':')[0].trim();
                } else {
                    // Fallback to word logic
                    const words = movie.title.split(' ');
                    if (words.length > 1) {
                        if (words[0].length <= 3 && words.length > 2) {
                            keywords = words.slice(0, 3).join(' ');
                        } else {
                            keywords = words.slice(0, 2).join(' ');
                        }
                    }
                }

                const url = new URL(KINO_SEARCH_BASE);
                url.searchParams.set("q", keywords);
                const res = await fetch(url);
                const data = await res.json();

                if (data && data.results && data.results.length > 0) {
                    let rawRelated = data.results
                        .filter(m => m.id !== movie.id && m.poster && m.rating > 3);

                    const related = deduplicate(rawRelated, keywords).slice(0, 6);

                    if (related.length > 0) {
                        relatedSection.style.display = 'block';
                        related.forEach(r => {
                            const el = document.createElement('div');
                            el.className = 'related-card';
                            el.innerHTML = `<img src="${posterUrl(r.poster)}" title="${escapeHtml(r.title)}" loading="lazy">`;
                            el.onclick = () => {
                                openOverlay(r);
                            };
                            relatedGrid.appendChild(el);
                        });
                    }
                }
            } catch (e) {
                console.warn("Related fetch failed", e);
            }

            // Load Video
            loadVideo(movie, currentSeason, currentEpisode);

            // Show
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        }

        function renderTvControls(meta) {
            const seasonTabs = document.getElementById('seasonTabs');
            const episodeGrid = document.getElementById('episodeGrid');

            // Defaults if meta is missing
            const totalSeasons = meta ? meta.totalSeasons : 10;
            const getEpisodeCount = (s) => (meta && meta.seasonCounts[s]) ? meta.seasonCounts[s] : 20;

            // Render Seasons
            seasonTabs.innerHTML = '';
            for (let s = 1; s <= totalSeasons; s++) {
                const btn = document.createElement('button');
                btn.className = `season-tab ${s === currentSeason ? 'active' : ''}`;
                btn.textContent = `Season ${s}`;
                btn.onclick = () => {
                    currentSeason = s;
                    currentEpisode = 1; // Reset ep on season change
                    renderTvControls(meta); // Re-render to update active classes
                    loadVideo(currentMovie, currentSeason, currentEpisode);
                    updateEpInfo();
                };
                seasonTabs.appendChild(btn);
            }

            // Render Episodes
            episodeGrid.innerHTML = '';
            const episodeCount = getEpisodeCount(currentSeason);

            for (let e = 1; e <= episodeCount; e++) {
                const btn = document.createElement('button');
                btn.className = `episode-btn ${e === currentEpisode ? 'active' : ''}`;
                btn.textContent = e;
                btn.onclick = () => {
                    currentEpisode = e;
                    renderTvControls(meta); // Update highlights
                    loadVideo(currentMovie, currentSeason, currentEpisode);
                    updateEpInfo();
                };
                episodeGrid.appendChild(btn);
            }

            // Scroll active season into view
            const activeSeason = seasonTabs.querySelector('.active');
            if (activeSeason) activeSeason.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        function updateEpInfo() {
            const epInfo = document.getElementById('overlayEpisodeInfo');
            if (epInfo.style.display !== 'none') {
                epInfo.textContent = `S${currentSeason}:E${currentEpisode}`;
            }
        }

        function loadVideo(movie, s, e) {
            const loader = document.getElementById('videoLoader');
            const container = document.getElementById('videoContainer');

            // Show loader
            loader.style.display = 'flex';
            container.innerHTML = '';

            const directUrl = buildDirectUrl(movie.id, movie.type, s, e);
            const src = PUBUP_BASE + encodeURIComponent(directUrl);

            const iframe = document.createElement('iframe');
            iframe.src = src;
            iframe.allow = "autoplay; fullscreen";
            iframe.allowFullscreen = true;
            iframe.referrerPolicy = "no-referrer";
            iframe.style.opacity = '0';
            iframe.style.transition = 'opacity 0.5s ease';

            iframe.onload = () => {
                setTimeout(() => {
                    loader.style.display = 'none';
                    iframe.style.opacity = '1';
                }, 2000); // 2 second delay
            };

            container.appendChild(iframe);
        }

        function closeOverlay() {
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.style.display = 'none';
                document.getElementById('videoContainer').innerHTML = '';
                currentMovie = null;
            }, 300);
        }

        // --- Navbar Effects ---
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) navbar.classList.add('scrolled');
            else navbar.classList.remove('scrolled');
        });

        // --- Init ---
        // Expose functions
        window.closeOverlay = closeOverlay;
        window.resetHome = () => init();


        // Run
        init();
    </script>
</body>

</html>
