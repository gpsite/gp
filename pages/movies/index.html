<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie Catalog</title>
  <link rel="icon" type="image/gif" href="https://gp-site.github.io/gp/img/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { margin: 0; background: #000; color: #ccc; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 80px; background: #0e0f13; border-radius: 20px; margin: 20px; display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px; }
    .circle-btn { width: 45px; height: 45px; background: #222428; border-radius: 50%; margin: 10px 0; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 18px; cursor: pointer; position: relative; transition: all 0.3s ease; overflow: visible; }
    .circle-btn input { position: absolute; left: 50px; width: 0; opacity: 0; border: none; outline: none; padding: 5px 10px; border-radius: 10px; background: #2b2e33; color: #fff; transition: all 0.3s ease; }
    .circle-btn.active input { height: 20px; width: 200px; opacity: 1; }
    .filter-menu { position: absolute; top: 0; left: 55px; background: #222428; border-radius: 10px; padding: 0; display: flex; flex-direction: row; flex-wrap: wrap; gap: 5px; max-width: none; width: auto; min-width: 200px; overflow-x: hidden; overflow-y: visible; opacity: 0; pointer-events: none; transition: all 0.3s ease; z-index: 1; }
    .circle-btn.active .filter-menu { max-height: 400px; opacity: 1; padding: 10px; pointer-events: auto; user-select: auto; }
    .filter-menu button { background: #2b2e33; color: #fff; border: none; padding: 5px; border-radius: 6px; white-space: nowrap; cursor: pointer; text-align: left;}
    .filter-menu button:hover { background: #13141a; }
    .scrollbar { flex: 1; width: 100%; display: flex; justify-content: center; margin: 20px 0; position: relative; }
    .track { position: absolute; top: 10px; bottom: 10px; width: 10px; border-radius: 5px; background: #222428; }
    .thumb { width: 55px; height: 35px; background: #222428; border-radius: 10px; position: absolute; top: 0; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .thumb div { width: 40%; height: 3px; background: #fff; margin: 2px 0; border-radius: 2px; }
    .catalog-frame { flex: 1; margin: 20px; border-radius: 20px; border-style: solid; border-width: 3px; border-color: #0e0f13; background: rgba(14,15,19,0.85); backdrop-filter: blur(16px); padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
    .catalog-inner { flex: 1; border-radius: 15px; padding: 15px; overflow-y: scroll; scrollbar-width: none; }
    .catalog-inner::-webkit-scrollbar { display: none; }
    .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
    .movie-card { background: #222428; border-radius: 15px; padding: 8px; text-align: center; cursor: pointer; }
    .movie-card h3 { font-size: 13px; margin: 5px 0; color: #fff; }
    .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 10px; background: #444; }
    .movie-card p { font-size: 11px; color: #fff; margin: 5px 0 0; }
    #homeBtn { margin-top: auto; }
    .movie-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    .movie-overlay video { max-width: 80vw; max-height: 60vh; border-radius: 12px; background: #000; }
    .movie-info { max-width: 800px; margin-top: 15px; color: #fff; text-align: left; }
    .movie-info h2 { margin: 0 0 10px; }
    .overlay-controls { margin-top: 15px; display: flex; gap: 10px; }
    .overlay-controls button { background: #222428; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; }
    .overlay-controls button:hover { background: #2b2e33; }
  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>

  <div class="sidebar">
    <div class="circle-btn" id="searchBtn"><i class="fa fa-search"></i><input type="text" id="searchInput" placeholder="Search..."></div>
    <div class="circle-btn" id="filterBtn"><i class="fa fa-filter"></i><div class="filter-menu" id="filterMenu"></div></div>
    <div class="scrollbar"><div class="track"></div><div class="thumb"><div></div><div></div><div></div></div></div>
    <a class="circle-btn" id="homeBtn" href="../../index.html"><i class="fa fa-home"></i></a>
  </div>

  <div class="catalog-frame">
    <div class="catalog-inner" id="catalog">
      <div class="movie-grid" id="movieGrid"></div>
    </div>
  </div>

  <div class="movie-overlay" id="movieOverlay">
    <div id="movieContainer"></div>
    <div class="movie-info" id="movieInfo"></div>
    <div class="overlay-controls">
      <button onclick="toggleFullscreen()">Bordered Fullscreen</button>
      <button onclick="closeOverlay()">Close</button>
    </div>
  </div>

  <script>
    const SHEET_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/testmovies?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';
    const catalog = document.getElementById("catalog");
    const thumb = document.querySelector(".thumb");
    const movieGrid = document.getElementById("movieGrid");
    const track = document.querySelector(".track");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");
    const overlay = document.getElementById("movieOverlay");
    const movieContainer = document.getElementById("movieContainer");
    const movieInfo = document.getElementById("movieInfo");

    let allMovies = [];
    let categories = new Set();

    function generateKeyThreeDates() {
      const pad = (n) => String(n).padStart(2, '0');
      const makeYMD = (d) =>
        d.getFullYear().toString() +
        pad(d.getMonth() + 1) +
        pad(d.getDate());
      const now = new Date();
      const day0 = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
      const day1 = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const day2 = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
      return makeYMD(day0) + makeYMD(day1) + makeYMD(day2);
    }

    function buildMovieUrl(raw) {
      if (!raw) return '';
      let s = String(raw).trim();
      s = s.replace(/\?k=.*$/, '');
      const vaultMatch = s.match(/vault\.rips\.cc\/video\/(.+)$/i);
      if (vaultMatch && vaultMatch[1]) {
        const path = vaultMatch[1];
        return `https://vault.rips.cc/video/${path}?k=${generateKeyThreeDates()}`;
      }
      const id = s.replace(/^https?:\/\//i, '').replace(/^\/+|\/+$/g, '');
      return `https://vault.rips.cc/video/${id}?k=${generateKeyThreeDates()}`;
    }

    async function fetchMovieData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        const rows = data.values;
        const headers = rows.shift();

        const urlIndex = headers.indexOf('URL');
        const imdbIndex = headers.indexOf('IMDB ID');
        const titleIndex = headers.indexOf('TITLE');
        const catIndex = headers.indexOf('CATEGORIES');
        const yearIndex = headers.indexOf('YEAR');
        const directorIndex = headers.indexOf('DIRECTOR');
        const actorsIndex = headers.indexOf('ACTORS');
        const plotIndex = headers.indexOf('PLOT');
        const posterIndex = headers.indexOf('POSTER');

        allMovies = rows.map(row => ({
          rawUrl: row[urlIndex] || '',
          url: buildMovieUrl(row[urlIndex] || ''),
          imdb: row[imdbIndex] || '',
          title: row[titleIndex] || '',
          categories: row[catIndex] ? row[catIndex].split(',').map(c => c.trim()) : [],
          year: row[yearIndex] || '',
          director: row[directorIndex] || '',
          actors: row[actorsIndex] || '',
          plot: row[plotIndex] || '',
          poster: row[posterIndex] || ''
        }));

        categories = new Set();
        allMovies.forEach(m => m.categories.forEach(c => categories.add(c)));
        buildFilters();
        renderMovies(allMovies);
      } catch (e) { console.error("Error fetching movie data", e); }
    }

     function renderMovies(movies) {
      movieGrid.innerHTML = "";
      movies.forEach(movie => {
        const card = document.createElement("div");
        card.className = "movie-card";
        card.innerHTML = `
          <img src="${movie.poster}" alt="${movie.title}">
          <h3>${movie.title}</h3>
          <p>${movie.categories.join(', ')}</p>
        `;
        card.addEventListener("click", () => openOverlay(movie));
        movieGrid.appendChild(card);
      });
    }

    function buildFilters() {
      filterMenu.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderMovies(allMovies);
      filterMenu.appendChild(allBtn);
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => renderMovies(allMovies.filter(m => m.categories.includes(cat)));
        filterMenu.appendChild(btn);
      });
    }

    function openOverlay(movie) {
      const finalUrl = buildMovieUrl(movie.rawUrl || movie.url);
      movieContainer.innerHTML = `
        <video controls>
          <source src="${finalUrl}" type="video/mp4">
          Your browser does not support video.
        </video>
      `;
      movieInfo.innerHTML = `
        <h2>${movie.title} (${movie.year})</h2>
        <p><strong>Director:</strong> ${movie.director}</p>
        <p><strong>Actors:</strong> ${movie.actors}</p>
        <p><strong>Plot:</strong> ${movie.plot}</p>
      `;
      overlay.style.display = "flex";
    }

    function closeOverlay() {
      overlay.style.display = "none";
      movieContainer.innerHTML = "";
      movieInfo.innerHTML = "";
    }

    function toggleFullscreen() {
      const videoEl = document.querySelector("#movieContainer video");
      if (!videoEl) return;

      const videoSrc = videoEl.querySelector("source")?.src || videoEl.src;
      if (!videoSrc) return;

      const newTab = window.open("", "_blank");
      if (!newTab) return;

      newTab.document.write(`
        <html>
          <head>
            <title>${document.title} - Bordered Fullscreen</title>
            <style>
              html, body { margin: 0; padding: 0; height: 100%; background: #000; }
              video { width: 100%; height: 100%; border: 4px solid #222; box-sizing: border-box; background: #000; }
            </style>
          </head>
          <body>
            <video src="${videoSrc}" controls autoplay></video>
          </body>
        </html>
      `);
      newTab.document.close();
    }

    function syncThumb() {
      const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
      const trackHeight = track.clientHeight - thumb.clientHeight;
      thumb.style.top = (track.offsetTop + ratio * trackHeight) + "px";
    }
    catalog.addEventListener("scroll", syncThumb);

    let dragging = false, startY, startTop;
    thumb.addEventListener("mousedown", e => {
      dragging = true;
      startY = e.clientY;
      startTop = parseInt(thumb.style.top) || 0;
      thumb.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if (!dragging) return;
      const dy = e.clientY - startY;
      const trackHeight = track.clientHeight - thumb.clientHeight;
      let newTop = Math.min(track.offsetTop + trackHeight, Math.max(track.offsetTop, startTop + dy));
      thumb.style.top = newTop + "px";
      const ratio = (newTop - track.offsetTop) / trackHeight;
      catalog.scrollTop = ratio * (catalog.scrollHeight - catalog.clientHeight);
    });
    document.addEventListener("mouseup", () => { dragging = false; thumb.style.cursor = "grab"; });

    searchBtn.addEventListener("click", () => {
      searchBtn.classList.toggle("active");
      if (searchBtn.classList.contains("active")) searchInput.focus();
      else { searchInput.value = ""; renderMovies(allMovies); }
    });
    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      renderMovies(allMovies.filter(m => m.title.toLowerCase().includes(term)));
    });
    filterBtn.addEventListener("click", () => filterBtn.classList.toggle("active"));
    document.addEventListener("keydown", e => { if (e.key === "Escape" && overlay.style.display === "flex") closeOverlay(); });

    fetchMovieData();
  </script>

  <script src="/gp/scripts/starry-background.js"></script>
  <script>
    setupStarryBackground();
  </script>

</body>
</html>