<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Movie Catalog - GP</title>
  <link rel="icon" type="image/png" href="https://gpsite.github.io/gp/img/logo.png">

  <!-- Poppins (same as GP) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
  <script src="https://gpsite.github.io/gp/js/effects-manager.js"></script>

  <style>
    :root{
      --bg-image: url("https://gpsite.github.io/gpmedia/img/home/winter-bg.png");
      --glass-bg: rgba(255,255,255,0.12);
      --glass-bg-hover: rgba(255,255,255,0.18);
      --glass-border: rgba(255,255,255,0.35);
      --glass-highlight: rgba(255,255,255,0.55);
      --text: #ffffff;
      --muted: #cfcfcf;
      --accent: rgba(255,255,255,0.06);
    }

    html,body{height:100%; margin:0;}
    body{
      color:var(--text);
      font-family:"Poppins","Segoe UI",system-ui,-apple-system,Arial,Helvetica,sans-serif;
      -webkit-font-smoothing:antialiased;
      background: var(--bg-image) center / cover no-repeat fixed;
      display:flex;
      height:100vh;
      overflow:hidden;
    }

    /* Layout */
    .app {
      display:flex;
      width:100%;
      max-width:var(--max-width);
      margin: 28px auto;
      gap:18px;
      padding: 20px;
      box-sizing:border-box;
      align-items:stretch;
      width: calc(100% - 56px);
    }

    /* Sidebar (glass) */
    .sidebar {
      width: 80px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(12px) saturate(120%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 var(--glass-highlight);
      border-radius: 20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      box-sizing:border-box;
      padding-bottom: 10px;
      z-index: 10;
    }

    .circle-btn { width: 46px; height: 46px; background: rgba(0,0,0,0.24); border-radius: 50%; margin: 6px 0; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 18px; cursor: pointer; position: relative; transition: transform .15s ease, box-shadow .15s ease; z-index: 9001;}
    .circle-btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.45); }
    .circle-btn input { position: absolute; left: 56px; width: 0; opacity: 0; border: none; outline: none; padding: 6px 10px; border-radius: 10px; background: rgba(0,0,0,0.7); color: #fff; transition: all 0.2s ease; z-index: 9002; }
    .circle-btn.active input { width: 220px; opacity: 1; height: 32px; top: 6px; z-index: 9003;}

    .filter-menu { position: absolute; top: 8px; left: 62px; background: rgba(0,0,0,0.7); border-radius: 10px; padding: 8px; display: flex; flex-direction: row; flex-wrap: wrap; gap: 6px; max-width: 240px; opacity: 0; pointer-events: none; transition: all 0.18s ease; z-index: 1000; }
    .circle-btn.active .filter-menu { opacity: 1; pointer-events: auto; }

    .filter-menu button { background: rgba(255,255,255,0.04); color: #fff; border: none; padding: 6px 8px; border-radius: 6px; white-space: nowrap; cursor: pointer; font-size: 13px; }
    .filter-menu button:hover { background: rgba(255,255,255,0.07); }

    .scrollbar { flex: 1; width:100%; display:flex; align-items:center; justify-content:center; position:relative; margin-top:6px; }
    .track { position:absolute; top:8px; bottom:8px; width: 10px; border-radius: 8px; background: rgba(0,0,0,0.24); }
    .thumb { width: 54px; height: 34px; background: rgba(0,0,0,0.24); border-radius: 10px; position: absolute; top: 8px; cursor: grab; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .thumb div { width: 40%; height: 3px; background: #fff; margin: 2px 0; border-radius: 2px; opacity: .85; }

    a.home-btn { margin-top: auto; width:46px; height:46px; display:flex; align-items:center; justify-content:center; text-decoration:none; color:#fff; background: rgba(0,0,0,0.24); border-radius:50%; }
    a.home-btn:hover{ transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.45); }

    /* Catalog (glass) */
    .catalog-frame {
      flex:1;
      border-radius: 16px;
      border: 1px solid var(--glass-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding: 14px;
      box-sizing: border-box;
      backdrop-filter: blur(10px) saturate(120%);
      display:flex;
      flex-direction:column;
      min-height: 68vh;
      box-shadow: 0 12px 40px rgba(0,0,0,0.45), inset 0 1px 0 var(--glass-highlight);
    }

    .catalog-inner {
      flex:1;
      border-radius: 10px;
      padding: 12px;
      overflow-y: scroll; 
      scrollbar-width: none; 
      
    }

    .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 18px; align-items:start; }
    .movie-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.16)); border-radius: 12px; box-shadow: 0 18px 40px rgba(0,0,0,0.45); padding: 8px; text-align:center; cursor:pointer; transition: transform .12s ease, box-shadow .12s ease; border: 1px solid rgba(255,255,255,0.03); }
    .movie-card:hover { transform: translateY(-6px); }
    .movie-card h3 { font-size: 13px; margin: 5px 0; color: #fff; font-weight:700; }
    .movie-card img { width: 100%; aspect-ratio: 2 / 3; object-fit: cover; border-radius: 8px; background: #333; display:block; }
    .movie-card p { font-size: 11px; color: var(--muted); margin: 6px 0 0; }

    /* overlay for movie iframe (above leaves) */
    .movie-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9999; padding: 20px; box-sizing: border-box; overflow-y: auto; }
    .movie-overlay video { max-width: 80vw; max-height: 60vh; border-radius: 12px; background: #000; }
    .movie-info { max-width: 800px; margin-top: 15px; color: #fff; text-align: left; }
    .movie-info h2 { margin: 0 0 10px; }
    .overlay-controls { margin-top: 15px; display: flex; gap: 10px; }
    .overlay-controls button { background: #222428; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer; }
    .overlay-controls button:hover { background: #2b2e33; }

    /* Responsive */
    @media (max-width: 920px){
      .app { flex-direction: column; margin: 16px; width: calc(100% - 32px); }
      .sidebar { width: 100%; flex-direction: row; padding: 8px; gap: 8px; border-radius: 12px; }
      .circle-btn input { left: auto; right: 8px; }
      .filter-menu { left: 8px; top: 56px; }
      .catalog-frame { min-height: 60vh; }
      .movie-overlay iframe { width: 96vw; height: 72vh; }
    }

    /* Falling leaves overlay (decorative) - lower z than overlay */
    .leaf-layer{
      position:fixed;
      inset:0;
      z-index:8000; /* under the movie overlay but above background */
      pointer-events:none;
      overflow:hidden;
    }
    .leaf{
      position:absolute;
      top:-10vh;
      left:0;
      width:1em;
      height:1em;
      transform: translateY(-10vh);
      animation: fall var(--fall-duration, 14s) linear var(--delay, 0s) infinite;
      will-change: transform;
      opacity: var(--opacity, .95);
    }
    .leaf .sway{
      display:inline-block;
      animation: sway var(--sway-duration, 4s) ease-in-out var(--delay, 0s) infinite alternate;
      will-change: transform;
    }
    .leaf .spin{
      display:inline-block;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
      animation: spin var(--spin-duration, 10s) linear var(--delay, 0s) infinite;
      will-change: transform;
    }

    @keyframes fall{
      0%{ transform: translateY(-10vh); }
      100%{ transform: translateY(110vh); }
    }
    @keyframes sway{
      0%{ transform: translateX(calc(var(--sway-range, 32px) * -1)); }
      100%{ transform: translateX(var(--sway-range, 32px)); }
    }
    @keyframes spin{
      100%{ transform: rotate(360deg); }
    }

    @media (prefers-reduced-motion: reduce){
      .leaf-layer{ display:none !important; }
    }
  </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-72B0YVX3BS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-72B0YVX3BS');
</script>
  
<body>

  <!-- Falling leaves layer (decorative) -->
  <div class="leaf-layer" id="leaf-layer" aria-hidden="true"></div>

  <div class="app" role="main" aria-label="Movie catalog application">
    <!-- Sidebar -->
    <div class="sidebar" aria-hidden="false">
      <div class="circle-btn" id="searchBtn" title="Search">
        <i class="fa fa-search"></i>
        <input type="text" id="searchInput" placeholder="Search...">
      </div>

      <div class="circle-btn" id="filterBtn" title="Filters">
        <i class="fa fa-filter"></i>
        <div class="filter-menu" id="filterMenu" aria-hidden="true"></div>
      </div>

      <div class="circle-btn" id="seriesBtn" title="Series">
        <i class="fa fa-list-ol"></i>
        <div class="filter-menu" id="seriesMenu" aria-hidden="true"></div>
      </div>

      <div class="scrollbar" aria-hidden="true">
        <div class="track"></div>
        <div class="thumb" id="thumb"><div></div><div></div><div></div></div>
      </div>

      <a class="home-btn" id="homeBtn" href="../../index.html" title="Home"><i class="fa fa-home"></i></a>
    </div>

    <!-- Catalog -->
    <div class="catalog-frame" onload="setserver(1)" role="region" aria-label="Movie catalog">
      <div class="catalog-inner" id="catalog">
        <div class="movie-grid" id="movieGrid" aria-live="polite" aria-atomic="false"></div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="movie-overlay" id="movieOverlay">
    <div id="movieContainer"></div>
    <div class="movie-info" id="movieInfo"></div>
    <div class="overlay-controls">
      <button id="subtitleBtn" onclick="toggleSubtitles()">Subtitles</button>
      <button onclick="toggleFullscreen()">Bordered Fullscreen</button>
      <button onclick="closeOverlay()">Close</button>
    </div>
  </div>

  <!-- Movie data + UI logic -->
<script>
    const SHEET_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/movies?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';
    const catalog = document.getElementById("catalog");
    const thumb = document.querySelector(".thumb");
    const movieGrid = document.getElementById("movieGrid");
    const track = document.querySelector(".track");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");
    const seriesBtn = document.getElementById("seriesBtn");
    const seriesMenu = document.getElementById("seriesMenu");
    const overlay = document.getElementById("movieOverlay");
    const movieContainer = document.getElementById("movieContainer");
    const movieInfo = document.getElementById("movieInfo");

    fucntion setserver(number) {
      return number
    };
  
    let allMovies = [];
    let categories = new Set();
    let currentMovie = null;
    let series = new Map();
    let server = setserver();

    function generateKeyThreeDates(server) {
      const pad = (n) => String(n).padStart(2, '0');
        
      // Use UTC to avoid local timezone issues
      const now = new Date();
      const utcYear = now.getUTCFullYear();
      const utcMonth = now.getUTCMonth();
      const utcDate = now.getUTCDate();


      const daybeforeyesterday = new Date(Date.UTC(utcYear, utcMonth, utcDate - 2));
      const yesterday = new Date(Date.UTC(utcYear, utcMonth, utcDate - 1));
      const today = new Date(Date.UTC(utcYear, utcMonth, utcDate));
      const tomorrow = new Date(Date.UTC(utcYear, utcMonth, utcDate + 1));
      const dayaftertomorrow = new Date(Date.UTC(utcYear, utcMonth, utcDate + 2));
      
      function makeYMD(date) {
        return date.getUTCFullYear() + pad(date.getUTCMonth() + 1) + pad(date.getUTCDate());
      }
    
      if (server = 1) {return makeYMD(yesterday) + makeYMD(today) + makeYMD(tomorrow)};
      if (server = 2) {return makeYMD(daybeforeyesterday) + makeYMD(yesterday) + makeYMD(today)};
      if (server = 3) {return makeYMD(today) + makeYMD(tomorrow) + makeYMD(dayaftertomorrow)};
    }

    function buildMovieUrl(raw) {
      if (!raw) return '';
      let s = String(raw).trim();
      s = s.replace(/\?k=.*$/, '');
      const vaultMatch = s.match(/vault\.rips\.cc\/video\/(.+)$/i);
      if (vaultMatch && vaultMatch[1]) {
        const path = vaultMatch[1];
        return `https://vault.rips.cc/video/${path}?k=${generateKeyThreeDates()}`;
      }
      const id = s.replace(/^https?:\/\//i, '').replace(/^\/+|\/+$/g, '');
      return `https://vault.rips.cc/video/${id}?k=${generateKeyThreeDates()}`;
    }

    async function fetchMovieData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        const rows = data.values;
        const headers = rows.shift();

        const urlIndex = headers.indexOf('URL');
        const imdbIndex = headers.indexOf('IMDB ID');
        const titleIndex = headers.indexOf('TITLE');
        const catIndex = headers.indexOf('CATEGORIES');
        const yearIndex = headers.indexOf('YEAR');
        const directorIndex = headers.indexOf('DIRECTOR');
        const actorsIndex = headers.indexOf('ACTORS');
        const plotIndex = headers.indexOf('PLOT');
        const posterIndex = headers.indexOf('POSTER');
        const subtitleUrlIndex = headers.indexOf('SUBTITLES');

        allMovies = rows.map(row => ({
          rawUrl: row[urlIndex] || '',
          url: buildMovieUrl(row[urlIndex] || ''),  // ok
          imdb: row[imdbIndex] || '',
          title: row[titleIndex] || '',
          categories: row[catIndex] ? row[catIndex].split(',').map(c => c.trim()) : [],
          year: row[yearIndex] || '',
          director: row[directorIndex] || '',
          actors: row[actorsIndex] || '',
          plot: row[plotIndex] || '',
          poster: row[posterIndex] || '',
          subtitleUrl: row[subtitleUrlIndex] || ''
        }));

        categories = new Set();
        allMovies.forEach(m => m.categories.forEach(c => categories.add(c)));
        buildFilters();
        identifySeries();       
        buildSeriesFilters();
        renderMovies(allMovies);
      } catch (e) { console.error("Error fetching movie data", e); }
    }
    
    

     function renderMovies(movies) {
      movieGrid.innerHTML = "";
      movies.forEach(movie => {
        const card = document.createElement("div");
        card.className = "movie-card";
        card.innerHTML = `
          <img src="${movie.poster}" alt="${movie.title}">
          <h3>${movie.title}</h3>
          <p>${movie.categories.join(', ')}</p>
        `;
        card.addEventListener("click", () => openOverlay(movie));
        movieGrid.appendChild(card);
      });
    }

    function buildFilters() {
      filterMenu.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderMovies(allMovies);
      filterMenu.appendChild(allBtn);
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => renderMovies(allMovies.filter(m => m.categories.includes(cat)));
        filterMenu.appendChild(btn);
      });
    }
    
    function buildSeriesFilters() {
      seriesMenu.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderMovies(allMovies);
      seriesMenu.appendChild(allBtn);

      series.forEach((movies, label) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.onclick = () => renderMovies(movies);
        seriesMenu.appendChild(btn);
      });
    }

    function identifySeries() {
  series.clear();
  const normalize = s => s.toLowerCase().replace(/\s+/g, ' ').trim();

  // Sort alphabetically
  const sorted = [...allMovies].filter(m => m.title).sort((a, b) => a.title.localeCompare(b.title, undefined, {sensitivity:'base'}));

  const buckets = new Map();

  sorted.forEach(movie => {
    const title = normalize(movie.title);

    // Base key: take up to colon, "and", or last number if not a year
    const colonIndex = title.indexOf(':');
    const andIndex = title.indexOf(' and ');
    const numMatch = title.match(/\b([0-9]+|[ivxlcdm]+)$/i);
    let keyEnd = title.length;

    if (colonIndex !== -1) keyEnd = Math.min(keyEnd, colonIndex);
    if (andIndex !== -1) keyEnd = Math.min(keyEnd, andIndex);
    if (numMatch) {
      const n = parseInt(numMatch[1], 10);
      if (!(n >= 1900 && n <= 2099)) keyEnd = Math.min(keyEnd, numMatch.index);
    }

    const key = title.slice(0, keyEnd).trim();

    if (!buckets.has(key)) buckets.set(key, []);
    buckets.get(key).push(movie);
  });

  // Only keep buckets with 2+ movies (optional)
  buckets.forEach((movies, key) => {
    if (movies.length > 1) {
      series.set(movies[0].title.split(' ').slice(0,2).join(' '), movies);
    }
  });
}
    

    function openOverlay(movie) {
      currentMovie = movie;
      const finalUrl = movie.url;

      const subtitleBtn = document.getElementById('subtitleBtn');
      if (movie.subtitleUrl && movie.subtitleUrl.trim() !== '') {
        subtitleBtn.style.display = 'inline-block';
      } else {
        subtitleBtn.style.display = 'none';
      }
      
      movieContainer.innerHTML = `
        <video controls>
          <source src="${finalUrl}" type="video/mp4">
          Your browser does not support video.
        </video>
      `;
      movieInfo.innerHTML = `
        <h2>${movie.title} (${movie.year})</h2>
        <p><strong>Director:</strong> ${movie.director}</p>
        <p><strong>Actors:</strong> ${movie.actors}</p>
        <p><strong>Plot:</strong> ${movie.plot}</p>
      `;
      overlay.style.display = "flex";
    }

    function closeOverlay() {
      overlay.style.display = "none";
      movieContainer.innerHTML = "";
      movieInfo.innerHTML = "";
      currentMovie = null;
    }

    function toggleFullscreen() {
      const videoEl = document.querySelector("#movieContainer video");
      if (!videoEl) return;

      const videoSrc = videoEl.querySelector("source")?.src || videoEl.src;
      if (!videoSrc) return;

      const newTab = window.open("", "_blank");
      if (!newTab) return;

      newTab.document.write(`
        <html>
          <head>
            <title>${document.title} - Bordered Fullscreen</title>
            <style>
              html, body { margin: 0; padding: 0; height: 100%; background: #000; }
              video { width: 100%; height: 100%; border: 4px solid #222; box-sizing: border-box; background: #000; }
            </style>
          </head>
          <body>
            <video src="${videoSrc}" controls autoplay></video>
          </body>
        </html>
      `);
      newTab.document.close();
    }
    
    function closeOtherMenus(opening) {
    if (opening !== 'filter') filterBtn.classList.remove('active');
    if (opening !== 'series') seriesBtn.classList.remove('active');
    if (opening !== 'search') {
      searchBtn.classList.remove('active');
      searchInput.value = "";
    }
  }

    function srtToVtt(srtText) {
        let vttText = "WEBVTT\n\n";
        const blocks = srtText.trim().replace(/\r/g, '').split('\n\n');

        for (const block of blocks) {
            const lines = block.split('\n');
            if (lines.length < 2) continue;

            const timestamp = lines[1];
            if (timestamp && timestamp.includes('-->')) {
                const vttTimestamp = timestamp.replace(/,/g, '.');
                vttText += vttTimestamp + '\n';

                const text = lines.slice(2).join('\n');
                vttText += text + '\n\n';
            }
        }
        return vttText;
    }

    async function toggleSubtitles() {
      const videoEl = document.querySelector("#movieContainer video");
      if (!videoEl || !currentMovie) return;

      const existingTrack = videoEl.querySelector("track");
      if (existingTrack) {
        const subtitleTrack = Array.from(videoEl.textTracks).find(t => t.kind === 'subtitles');
        if (subtitleTrack) {
          subtitleTrack.mode = subtitleTrack.mode === "showing" ? "hidden" : "showing";
        }
        return;
      }

      if (!currentMovie.subtitleUrl) {
        alert("No subtitle URL found for this movie.");
        return;
      }

      try {
        const response = await fetch(currentMovie.subtitleUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const srtText = await response.text();
        const vttText = srtToVtt(srtText);

        const vttBlob = new Blob([vttText], { type: 'text/vtt' });
        const vttUrl = URL.createObjectURL(vttBlob);

        const track = document.createElement("track");
        track.kind = "subtitles";
        track.label = "English";
        track.srclang = "en";
        track.src = vttUrl;
        track.default = true;
        videoEl.appendChild(track);
        
        setTimeout(() => {
             const subtitleTrack = Array.from(videoEl.textTracks).find(t => t.kind === 'subtitles');
             if(subtitleTrack) subtitleTrack.mode = 'showing';
        }, 100);

      } catch (e) {
        console.error("Error fetching or converting subtitles:", e);
        alert("Could not load subtitles.");
      }
    }

    function updateTrackHole() {
  const trackRect = track.getBoundingClientRect();
  const thumbRect = thumb.getBoundingClientRect();
  const topRel = Math.max(0, thumbRect.top - trackRect.top);
  const bottomRel = Math.min(trackRect.height, topRel + thumbRect.height);

  const h = Math.max(1, Math.round(trackRect.height));
  const t = Math.round(topRel);
  const b = Math.round(bottomRel);

  const mask = `linear-gradient(to bottom, black 0px, black ${t}px, transparent ${t}px, transparent ${b}px, black ${b}px, black ${h}px)`;
  track.style.webkitMaskImage = mask;
  track.style.maskImage = mask;
}

// --- SYNC THUMB POSITION ---
function syncThumb() {
  const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
  const trackHeight = track.clientHeight - thumb.clientHeight;
  const newTop = track.offsetTop + ratio * trackHeight;
  thumb.style.top = newTop + "px";
  updateTrackHole();
}
catalog.addEventListener("scroll", syncThumb);
window.addEventListener("resize", syncThumb);

// --- DRAG HANDLER ---
let dragging = false;
    let startY, startTop;
    thumb.addEventListener("mousedown", e => {
      dragging = true;
      startY = e.clientY;
      startTop = parseInt(thumb.style.top) || 0;
      thumb.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if (!dragging) return;
      const dy = e.clientY - startY;
      const trackHeight = track.clientHeight - thumb.clientHeight;
      let newTop = Math.min(track.offsetTop + trackHeight, Math.max(track.offsetTop, startTop + dy));
      thumb.style.top = newTop + "px";
      const ratio = (newTop - track.offsetTop) / trackHeight;
      catalog.scrollTop = ratio * (catalog.scrollHeight - catalog.clientHeight);
    });
    document.addEventListener("mouseup", () => {
      dragging = false;
      thumb.style.cursor = "grab";
    });

    searchBtn.addEventListener("click", () => {
      searchBtn.classList.toggle("active");
      if (searchBtn.classList.contains("active")) searchInput.focus();
      else { searchInput.value = ""; renderMovies(allMovies); }
    });
    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      renderMovies(allMovies.filter(m => m.title.toLowerCase().includes(term)));
    });
        filterBtn.addEventListener("click", () => {
      const active = filterBtn.classList.toggle("active");
      if (active) closeOtherMenus('filter');
    });

    seriesBtn.addEventListener("click", () => {
      const active = seriesBtn.classList.toggle("active");
      if (active) closeOtherMenus('series');
    });
    document.addEventListener("keydown", e => { if (e.key === "Escape" && overlay.style.display === "flex") closeOverlay(); });

    fetchMovieData();
  </script>

  <!-- Falling leaves generator (copied from GP home) -->
  <script>
/**
 * Shared leaf / snow generator
 * Define window.initLeaves() so Effects Manager can turn snow off/on.
 */
window.initLeaves = function() {
  const layer = document.getElementById('leaf-layer');
  if (!layer) return;

  // Clear any existing leaves before (re)generating
  layer.innerHTML = '';
  layer.style.display = '';

  // Respect reduced motion
  try{
    if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      return;
    }
  }catch(e){}

  const LEAFS = ['❄️'];
  const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);

  // Scale number of leaves by viewport width (with sensible bounds)
  const COUNT = Math.max(12, Math.min(40, Math.round(vw / 40)));

  function rand(min, max){ return Math.random() * (max - min) + min; }

  function createLeaf() {
    const leaf = document.createElement('span');
    leaf.className = 'leaf';

    const sway = document.createElement('span');
    sway.className = 'sway';

    const spin = document.createElement('span');
    spin.className = 'spin';
    spin.textContent = LEAFS[Math.floor(Math.random() * LEAFS.length)];

    // Random properties
    const startLeftVw = rand(0, 100);
    const sizePx = rand(16, 36);
    const fallDuration = rand(10, 22); // seconds
    const swayDuration = rand(2.2, 5.2); // seconds
    const swayRange = rand(18, 60); // px
    const spinDuration = rand(6, 13); // seconds
    const delay = -rand(0, 22); // negative delay staggers leaves
    const opacity = rand(0.5, 1);

    leaf.style.left = startLeftVw.toFixed(2) + 'vw';
    leaf.style.setProperty('--fall-duration', fallDuration.toFixed(2) + 's');
    leaf.style.setProperty('--sway-duration', swayDuration.toFixed(2) + 's');
    leaf.style.setProperty('--sway-range', swayRange.toFixed(0) + 'px');
    leaf.style.setProperty('--spin-duration', spinDuration.toFixed(2) + 's');
    leaf.style.setProperty('--delay', delay.toFixed(2) + 's');
    leaf.style.setProperty('--opacity', opacity.toFixed(2));

    // Randomize spin direction
    spin.style.animationDirection = Math.random() < 0.5 ? 'normal' : 'reverse';
    spin.style.fontSize = sizePx.toFixed(0) + 'px';

    sway.appendChild(spin);
    leaf.appendChild(sway);
    layer.appendChild(leaf);
  }

  for (let i = 0; i < COUNT; i++){
    createLeaf();
  }

  // Optional: update density on resize (basic)
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      const current = layer.children.length;
      const vwNow = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
      const target = Math.max(12, Math.min(40, Math.round(vwNow / 40)));
      const toAdd = Math.max(0, target - current);
      for (let i = 0; i < toAdd; i++){
        createLeaf();
      }
    }, 250);
  });
};

// Run once on load
window.addEventListener('DOMContentLoaded', function(){
  if (typeof window.initLeaves === 'function') {
    window.initLeaves();
  }
});
</script>

  <script>
    // Initialize effects manager for MOVIES
    window.addEventListener('DOMContentLoaded', function(){
      window.initEffectsManager({
        backgroundFallback: '#222a3eff',
        glassSelectors: ['.sidebar', '.catalog-frame'],
        storageKey: 'gp-reduced-effects'
      });
    });
  </script>


</body>
</html>
