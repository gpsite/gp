<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Catalog</title>
  <link rel="icon" type="image/gif" href="https://gp-site.github.io/gp/img/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #ccc;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* main comps */
    .sidebar { width: 80px; background: #0e0f13; border-radius: 20px; margin: 20px; display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px; }
    .circle-btn { width: 45px; height: 45px; background: #222428; border-radius: 50%; margin: 10px 0; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 18px; cursor: pointer; position: relative; transition: all 0.3s ease; overflow: visible; }
    .circle-btn input { position: absolute; left: 50px; width: 0; opacity: 0; border: none; outline: none; padding: 5px 10px; border-radius: 10px; background: #2b2e33; color: #fff; transition: all 0.3s ease; z-index: 99; }
    .circle-btn.active input { height: 20px; width: 200px; opacity: 1; }
    .filter-menu { position: absolute; top: 0; left: 55px; background: #222428; border-radius: 10px; padding: 0; display: flex; flex-direction: row; flex-wrap: wrap; gap: 5px; max-width: 200px; overflow-x: hidden; overflow-y: visible; opacity: 0; pointer-events: none; transition: all 0.3s ease; z-index: 1; }
    .circle-btn.active .filter-menu { max-height: 400px; opacity: 1; padding: 10px; pointer-events: auto; user-select: auto; }
    .filter-menu button { background: #2b2e33; color: #fff; border: none; padding: 5px; border-radius: 6px; white-space: nowrap; cursor: pointer; text-align: left;}
    .filter-menu button:hover { background: #13141a; }
    .scrollbar { flex: 1; width: 100%; display: flex; justify-content: center; margin: 20px 0; position: relative; }
    .track { position: absolute; top: 10px; bottom: 10px; width: 10px; border-radius: 5px; background: #222428; }
    .thumb { width: 55px; height: 35px; background: #222428; border-radius: 10px; position: absolute; top: 0; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .thumb div { width: 40%; height: 3px; background: #fff; margin: 2px 0; border-radius: 2px; }
    .catalog-frame { flex: 1; margin: 20px; border-radius: 20px; border-style: solid; border-width: 8px; border-color: #0e0f13; background: rgba(14,15,19,0.1); backdrop-filter: blur(16px); padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
    .catalog-inner { flex: 1; border-radius: 15px; padding: 15px; overflow-y: scroll; scrollbar-width: none; }
    .catalog-inner::-webkit-scrollbar { display: none; }
    .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
    .game-card { background: #222428; border-radius: 15px; padding: 8px; text-align: center; cursor: pointer; }
    .game-card h3 { font-size: 13px; margin: 5px 0; color: #fff; }
    .game-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; background: #444; }
    .game-card p { font-size: 11px; color: #fff; margin: 5px 0 0; }
    #homeBtn { margin-top: auto; }

    /* overlay for game iframe */
    .game-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    .game-overlay iframe, .game-overlay object {
      width: 80vw;
      height: 80vh;
      border: none;
      border-radius: 12px;
      background: #000;
    }
    .overlay-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .overlay-controls button {
      background: #222428;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .overlay-controls button:hover { background: #2b2e33; }
  </style>
</head>
<body>
  
  <canvas id="bg-canvas"></canvas>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="circle-btn" id="searchBtn"><i class="fa fa-search"></i><input type="text" id="searchInput" placeholder="Search..."></div>
    <div class="circle-btn" id="filterBtn"><i class="fa fa-filter"></i><div class="filter-menu" id="filterMenu"></div></div>
    <div class="circle-btn" id="seriesBtn"><i class="fa fa-list-ol"></i><div class="filter-menu" id="seriesMenu"></div></div>
    <div class="scrollbar"><div class="track"></div><div class="thumb"><div></div><div></div><div></div></div></div>
    <a class="circle-btn" id="homeBtn" href="../../index.html"><i class="fa fa-home"></i></a>
  </div>

  <!-- Catalog -->
  <div class="catalog-frame">
    <div class="catalog-inner" id="catalog">
      <div class="game-grid" id="gameGrid"></div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="game-overlay" id="gameOverlay">
    <div id="gameContainer"></div>
    <div class="overlay-controls">
      <button onclick="toggleFullscreen()">Fullscreen</button>
      <button onclick="toggleBorderdFullscreen()">Borderd Fullscreen (progress wont save)</button>
      <button onclick="closeOverlay()">Close</button>
    </div>
  </div>

  <script>
    const SHEET_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/games?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';
    const catalog = document.getElementById("catalog");
    const thumb = document.querySelector(".thumb");
    const gameGrid = document.getElementById("gameGrid");
    const track = document.querySelector(".track");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");
    const seriesBtn = document.getElementById("seriesBtn");
    const seriesMenu = document.getElementById("seriesMenu");
    const overlay = document.getElementById("gameOverlay");
    const gameContainer = document.getElementById("gameContainer");

    let allGames = [];
    let categories = new Set();
    let series = new Map();

    // Fetch game data from Google Sheets
    async function fetchGameData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        const rows = data.values;
        const headers = rows.shift();
        const titleIndex = headers.indexOf('Title');
        const categoryIndex = headers.indexOf('Category');
        const urlIndex = headers.indexOf('URL');
        const thumbnailIndex = headers.indexOf('Thumbnail');
      
        allGames = rows.map(row => ({
          title: row[titleIndex],
          categories: row[categoryIndex] ? row[categoryIndex].split(',').map(c => c.trim()) : [],
          url: row[urlIndex],
          thumbnail: row[thumbnailIndex]
        }));
      
        // Build categories and filters
        categories = new Set();
        allGames.forEach(g => g.categories.forEach(c => categories.add(c)));
        buildFilters();
      
        // ALWAYS render first so the grid shows even if series logic fails
        renderGames(allGames);
      
        // Then try series (won't block initial render if it fails)
        try {
          identifySeries();       // your function (any version)
          buildSeriesFilters();   // guarded below
        } catch (e) {
          console.warn('Series disabled due to error:', e);
        }
      } catch (e) {
        console.error("Error fetching game data", e);
      }
    }

    // Render game cards
    function renderGames(games) {
      gameGrid.innerHTML = "";
      games.forEach(game => {
        const card = document.createElement("div");
        card.className = "game-card";
        card.innerHTML = `
          <h3>${game.title}</h3>
          <img src="${game.thumbnail}" alt="${game.title}">
          <p>${game.categories.join(', ')}</p>
        `;
        card.addEventListener("click", () => openOverlay(game));
        gameGrid.appendChild(card);
      });
    }

    // Build filter buttons
    function buildFilters() {
      filterMenu.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderGames(allGames);
      filterMenu.appendChild(allBtn);
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => renderGames(allGames.filter(g => g.categories.includes(cat)));
        filterMenu.appendChild(btn);
      });
    }

    function buildSeriesFilters() {
      seriesMenu.innerHTML = "";

      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderGames(allGames);
      seriesMenu.appendChild(allBtn);

      series.forEach((games, label) => {
        const btn = document.createElement("button");
        btn.textContent = label;
        btn.onclick = () => renderGames(games);
        seriesMenu.appendChild(btn);
      });
    }

    function identifySeries() {
      try {
        const sorted = [...allGames]
          .filter(g => g && g.title)
          .sort((a, b) => a.title.localeCompare(b.title, undefined, { sensitivity: 'base' }));
      
        const normalize = s => s.toLowerCase().replace(/\s+/g, ' ').trim();
        const numRegex = /(.+?)\s+([0-9]+|[IVXLCDM]+)$/i;
      
        function baseKey(title) {
          const t = normalize(title);
        
          // If title ends with a number/Roman numeral (not a year), strip it
          const m = t.match(numRegex);
          if (m) {
            const suffix = m[2];
            const n = parseInt(suffix, 10);
            if (!(n >= 1900 && n <= 2099)) return normalize(m[1]);
          }
        
          // Otherwise first two words
          return t.split(" ").slice(0, 2).join(" ");
        }
      
        // Step 1: build raw adjacency groups
        const buckets = new Map();
        let i = 0;
      
        while (i < sorted.length) {
          const key = baseKey(sorted[i].title);
          let run = [sorted[i]];
          let j = i + 1;

          while (j < sorted.length && baseKey(sorted[j].title) === key) {
            run.push(sorted[j]);
            j++;
          }
        
          if (run.length > 1) buckets.set(key, run);
        
          i = j;
        }
      
        // Step 2: retroactively pull in first non-numbered entry
        for (let [key, run] of buckets.entries()) {
          const first = run[0];
          const standaloneCandidateIndex = sorted.findIndex(g => normalize(g.title) === key);
        
          // If the base name appears exactly and isn't already included, add it
          if (standaloneCandidateIndex !== -1) {
            const standalone = sorted[standaloneCandidateIndex];
            if (!run.some(g => g.title === standalone.title)) {
              run.unshift(standalone);
            }
          }
        }
      
        // Step 3: finalize to global map
        series.clear();
        for (const [key, run] of buckets.entries()) {
          const label = run[0].title.split(" ").slice(0, 2).join(" ");
          if (run.length > 1) series.set(label, run);
        }
      } catch (e) {
        console.error("identifySeries dynamic error:", e);
        series.clear();
      }
    }

    // Open game overlay
    function openOverlay(game) {
      gameContainer.innerHTML = "";
      if (game.url.endsWith(".swf")) {
        gameContainer.innerHTML = `
          <object id="gameObject" type="application/x-shockwave-flash" data="${game.url}" width="650" height="450">
            <param name="movie" value="${game.url}">
            <param name="quality" value="high">
            <param name="wmode" value="transparent">
          </object>
        `;
      } else {
        gameContainer.innerHTML = `<iframe id="gameIframe" src="${game.url}" class="embed"></iframe>`;
      }
      overlay.style.display = "flex";
    }

    function closeOverlay() {
      overlay.style.display = "none";
      gameContainer.innerHTML = "";
    }

    function toggleFullscreen() {
      const el = document.querySelector("#gameIframe") || document.querySelector("#gameObject");
      if (!el) return;
      if (!document.fullscreenElement) {
        el.requestFullscreen().catch(err => console.error(err));
      } else {
        document.exitFullscreen();
      }
    }

    function toggleBorderdFullscreen() {
    const iframe = document.querySelector("#gameIframe");
    const swf = document.querySelector("#gameObject");
      
    let src = "";
    if (iframe) src = iframe.src;
    else if (swf) src = swf.getAttribute("data");
    if (!src) return;
      
    const newTab = window.open("", "_blank");
    if (!newTab) return;
      
    newTab.document.write(`
      <html>
        <head>
          <title>${document.title} - Bordered Fullscreen</title>
          <style>
            html, body {
              margin: 0;
              padding: 0;
              width: 100%;
              height: 100%;
              background: #000;
              display: flex;
              justify-content: center;
              align-items: center;
            }
            iframe, object {
              width: 100%;
              height: 100%;
              border: 4px solid #222;
              box-sizing: border-box;
              background: #000;
            }
          </style>
        </head>
        <body>
          ${iframe ? `<iframe src="${src}" allowfullscreen></iframe>` : `<object type="application/x-shockwave-flash" data="${src}"></object>`}
        </body>
      </html>
    `);
  }

  function closeOtherMenus(opening) {
    if (opening !== 'filter') filterBtn.classList.remove('active');
    if (opening !== 'series') seriesBtn.classList.remove('active');
    if (opening !== 'search') {
      searchBtn.classList.remove('active');
      searchInput.value = "";
    }
  }


    fetchGameData();

    // Sync scrollbar thumb position
    function syncThumb() {
      const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
      const trackHeight = track.clientHeight - thumb.clientHeight;
      thumb.style.top = (track.offsetTop + ratio * trackHeight) + "px";
    }
    catalog.addEventListener("scroll", syncThumb);

    let dragging = false;
    let startY, startTop;
    thumb.addEventListener("mousedown", e => {
      dragging = true;
      startY = e.clientY;
      startTop = parseInt(thumb.style.top) || 0;
      thumb.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if (!dragging) return;
      const dy = e.clientY - startY;
      const trackHeight = track.clientHeight - thumb.clientHeight;
      let newTop = Math.min(track.offsetTop + trackHeight, Math.max(track.offsetTop, startTop + dy));
      thumb.style.top = newTop + "px";
      const ratio = (newTop - track.offsetTop) / trackHeight;
      catalog.scrollTop = ratio * (catalog.scrollHeight - catalog.clientHeight);
    });
    document.addEventListener("mouseup", () => {
      dragging = false;
      thumb.style.cursor = "grab";
    });

    // --- Search functionality ---
    searchBtn.addEventListener("click", () => {
      const active = searchBtn.classList.toggle("active");
      if (active) {
        closeOtherMenus('search');
        searchInput.focus();
      } else {
        searchInput.value = "";
        renderGames(allGames);
      }
    });

    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      renderGames(allGames.filter(g => g.title.toLowerCase().includes(term)));
    });

    // --- Filter functionality ---
    filterBtn.addEventListener("click", () => {
      const active = filterBtn.classList.toggle("active");
      if (active) closeOtherMenus('filter');
    });

    seriesBtn.addEventListener("click", () => {
      const active = seriesBtn.classList.toggle("active");
      if (active) closeOtherMenus('series');
    });

    // --- Overlay escape key close ---
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && overlay.style.display === "flex") {
        closeOverlay();
      }
    });

  </script>

  <script src="/gp/scripts/starry-background.js"></script>
  <script>
    setupStarryBackground();
  </script>

</body>
</html>