<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game Catalog</title>
  <link rel="icon" type="image/gif" href="https://gp-site.github.io/gp/img/logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
  <style>
    body {
      margin: 0;
      color: #ccc;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* main comps */
    .sidebar { width: 80px; background: #0e0f13; border-radius: 20px; margin: 20px; display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px; }
    .circle-btn { width: 45px; height: 45px; background: #222428; border-radius: 50%; margin: 10px 0; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 18px; cursor: pointer; position: relative; transition: all 0.3s ease; overflow: visible; }
    .circle-btn input { position: absolute; left: 50px; width: 0; opacity: 0; border: none; outline: none; padding: 5px 10px; border-radius: 10px; background: #2b2e33; color: #fff; transition: all 0.3s ease; }
    .circle-btn.active input { height: 20px; width: 200px; opacity: 1; }
    .filter-menu { position: absolute; top: 0; left: 55px; background: #222428; border-radius: 10px; padding: 0; display: flex; flex-direction: row; flex-wrap: wrap; gap: 5px; max-width: 200px; overflow-x: hidden; overflow-y: visible; opacity: 0; pointer-events: none; transition: all 0.3s ease; z-index: 1; }
    .circle-btn.active .filter-menu { max-height: 400px; opacity: 1; padding: 10px; pointer-events: auto; user-select: auto; }
    .filter-menu button { background: #2b2e33; color: #fff; border: none; padding: 5px; border-radius: 6px; white-space: nowrap; cursor: pointer; text-align: left;}
    .filter-menu button:hover { background: #13141a; }
    .scrollbar { flex: 1; width: 100%; display: flex; justify-content: center; margin: 20px 0; position: relative; }
    .track { position: absolute; top: 10px; bottom: 10px; width: 10px; border-radius: 5px; background: #222428; }
    .thumb { width: 55px; height: 35px; background: #222428; border-radius: 10px; position: absolute; top: 0; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .thumb div { width: 40%; height: 3px; background: #fff; margin: 2px 0; border-radius: 2px; }
    .catalog-frame { flex: 1; margin: 20px; border-radius: 20px; background: #0e0f13; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
    .catalog-inner { flex: 1; border-radius: 15px; background: #13141a; padding: 15px; overflow-y: scroll; scrollbar-width: none; }
    .catalog-inner::-webkit-scrollbar { display: none; }
    .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
    .game-card { background: #222428; border-radius: 15px; padding: 8px; text-align: center; cursor: pointer; }
    .game-card h3 { font-size: 13px; margin: 5px 0; color: #fff; }
    .game-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; background: #444; }
    .game-card p { font-size: 11px; color: #fff; margin: 5px 0 0; }
    #homeBtn { margin-top: auto; }

    /* overlay for game iframe */
    .game-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    .game-overlay iframe, .game-overlay object {
      width: 80vw;
      height: 80vh;
      border: none;
      border-radius: 12px;
      background: #000;
    }
    .overlay-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .overlay-controls button {
      background: #222428;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .overlay-controls button:hover { background: #2b2e33; }


    #bg-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;           /* always fill viewport width */
      height: 100vh;          /* always fill viewport height */
      min-width: 100vw;
      min-height: 100vh;
      z-index: 0;             /* stay behind everything */
      pointer-events: none;   /* don't block clicks */
      display: block;
    }

  </style>
</head>
<body>

  <canvas id="bg-canvas"></canvas>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="circle-btn" id="searchBtn"><i class="fa fa-search"></i><input type="text" id="searchInput" placeholder="Search..."></div>
    <div class="circle-btn" id="filterBtn"><i class="fa fa-filter"></i><div class="filter-menu" id="filterMenu"></div></div>
    <div class="scrollbar"><div class="track"></div><div class="thumb"><div></div><div></div><div></div></div></div>
    <a class="circle-btn" id="homeBtn" href="../../index.html"><i class="fa fa-home"></i></a>
  </div>

  <!-- Catalog -->
  <div class="catalog-frame">
    <div class="catalog-inner" id="catalog">
      <div class="game-grid" id="gameGrid"></div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="game-overlay" id="gameOverlay">
    <div id="gameContainer"></div>
    <div class="overlay-controls">
      <button onclick="toggleFullscreen()">Fullscreen</button>
      <button onclick="closeOverlay()">Close</button>
    </div>
  </div>

  <script src="/scripts/starry-background.js"></script>

  <script>
    const SHEET_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/games?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';
    const catalog = document.getElementById("catalog");
    const thumb = document.querySelector(".thumb");
    const gameGrid = document.getElementById("gameGrid");
    const track = document.querySelector(".track");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const filterBtn = document.getElementById("filterBtn");
    const filterMenu = document.getElementById("filterMenu");
    const overlay = document.getElementById("gameOverlay");
    const gameContainer = document.getElementById("gameContainer");

    let allGames = [];
    let categories = new Set();

    setupStarryBackground();

    // Fetch game data from Google Sheets
    async function fetchGameData() {
      try {
        const response = await fetch(SHEET_URL);
        const data = await response.json();
        const rows = data.values;
        const headers = rows.shift();
        const titleIndex = headers.indexOf('Title');
        const categoryIndex = headers.indexOf('Category');
        const urlIndex = headers.indexOf('URL');
        const thumbnailIndex = headers.indexOf('Thumbnail');

        allGames = rows.map(row => ({
          title: row[titleIndex],
          categories: row[categoryIndex] ? row[categoryIndex].split(',').map(c => c.trim()) : [],
          url: row[urlIndex],
          thumbnail: row[thumbnailIndex]
        }));

        categories = new Set();
        allGames.forEach(g => g.categories.forEach(c => categories.add(c)));
        buildFilters();
        renderGames(allGames);
      } catch (e) { console.error("Error fetching game data", e); }
    }

    // Render game cards
    function renderGames(games) {
      gameGrid.innerHTML = "";
      games.forEach(game => {
        const card = document.createElement("div");
        card.className = "game-card";
        card.innerHTML = `
          <h3>${game.title}</h3>
          <img src="${game.thumbnail}" alt="${game.title}">
          <p>${game.categories.join(', ')}</p>
        `;
        card.addEventListener("click", () => openOverlay(game));
        gameGrid.appendChild(card);
      });
    }

    // Build filter buttons
    function buildFilters() {
      filterMenu.innerHTML = "";
      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => renderGames(allGames);
      filterMenu.appendChild(allBtn);
      categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.onclick = () => renderGames(allGames.filter(g => g.categories.includes(cat)));
        filterMenu.appendChild(btn);
      });
    }

    // Open game overlay
    function openOverlay(game) {
      gameContainer.innerHTML = "";
      if (game.url.endsWith(".swf")) {
        gameContainer.innerHTML = `
          <object id="gameObject" type="application/x-shockwave-flash" data="${game.url}" width="800" height="600">
            <param name="movie" value="${game.url}">
            <param name="quality" value="high">
            <param name="wmode" value="transparent">
          </object>
        `;
      } else {
        gameContainer.innerHTML = `<iframe id="gameIframe" src="${game.url}" class="embed"></iframe>`;
      }
      overlay.style.display = "flex";
    }

    function closeOverlay() {
      overlay.style.display = "none";
      gameContainer.innerHTML = "";
    }

    function toggleFullscreen() {
      const el = document.querySelector("#gameIframe") || document.querySelector("#gameObject");
      if (!el) return;
      if (!document.fullscreenElement) {
        el.requestFullscreen().catch(err => console.error(err));
      } else {
        document.exitFullscreen();
      }
    }

    fetchGameData();

    // Sync scrollbar thumb position
    function syncThumb() {
      const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
      const trackHeight = track.clientHeight - thumb.clientHeight;
      thumb.style.top = (track.offsetTop + ratio * trackHeight) + "px";
    }
    catalog.addEventListener("scroll", syncThumb);

    let dragging = false;
    let startY, startTop;
    thumb.addEventListener("mousedown", e => {
      dragging = true;
      startY = e.clientY;
      startTop = parseInt(thumb.style.top) || 0;
      thumb.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", e => {
      if (!dragging) return;
      const dy = e.clientY - startY;
      const trackHeight = track.clientHeight - thumb.clientHeight;
      let newTop = Math.min(track.offsetTop + trackHeight, Math.max(track.offsetTop, startTop + dy));
      thumb.style.top = newTop + "px";
      const ratio = (newTop - track.offsetTop) / trackHeight;
      catalog.scrollTop = ratio * (catalog.scrollHeight - catalog.clientHeight);
    });
    document.addEventListener("mouseup", () => {
      dragging = false;
      thumb.style.cursor = "grab";
    });

    // --- Search functionality ---
    searchBtn.addEventListener("click", () => {
      searchBtn.classList.toggle("active");
      if (searchBtn.classList.contains("active")) {
        searchInput.focus();
      } else {
        searchInput.value = "";
        renderGames(allGames);
      }
    });
    searchInput.addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      renderGames(allGames.filter(g => g.title.toLowerCase().includes(term)));
    });

    // --- Filter functionality ---
    filterBtn.addEventListener("click", () => {
      filterBtn.classList.toggle("active");
    });

    // --- Overlay escape key close ---
    document.addEventListener("keydown", e => {
      if (e.key === "Escape" && overlay.style.display === "flex") {
        closeOverlay();
      }
    });

  </script>
</body>
</html>