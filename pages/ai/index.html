<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GP-Clanker</title>
    <link rel="icon" type="image/x-icon" href="https://gpsite.github.io/gpmedia/img/logo.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"
        data-delimiters='[{"left":"$","right":"$","display":false},{"left":"$$","right":"$$","display":true}]'>
        </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/14.0.0/math.js"></script>
    <script src="https://unpkg.com/function-plot/dist/function-plot.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, Arial, sans-serif;
            background: #0b0e1a;
            color: #e8e9f1;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }


        .sidebar {
            width: 260px;
            background: #0f1326;
            border-right: 1px solid #1d2350;
            display: flex;
            flex-direction: column;
        }

        .logo {
            padding: 16px;
            font-weight: 600;
        }

        .version {
            font-size: 10px;
            opacity: 0.5;
            font-weight: 400;
            margin-top: 2px;
        }

        .logo-container {
            border-bottom: 1px solid #1d2350;
        }

        .new-chat {
            margin: 12px;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background: #4c5cff;
            color: white;
            cursor: pointer;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .chat-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .chat-item.active {
            background: #1d2350;
        }

        .delete-chat {
            color: #ff6b6b;
            cursor: pointer;
        }


        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #1d2350;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
        }

        .tab.active {
            background: #151a3a;
        }

        .workspace {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .panel.active {
            display: flex;
        }


        .messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .message {
            max-width: 75%;
            padding: 10px 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .user {
            background: #4c5cff;
            margin-left: auto;
        }

        .ai {
            background: #1d2350;
            margin-right: auto;
        }

        .input-area {
            display: flex;
            padding: 12px;
            border-top: 1px solid #1d2350;
        }

        .input-area input {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
        }

        .input-area button {
            margin-left: 8px;
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            background: #4c5cff;
            color: white;
            cursor: pointer;
        }


        .welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 12px;
        }

        .welcome h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .welcome p {
            font-size: 14px;
            opacity: 0.8;
        }

        .welcome-input {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .welcome-input input {
            width: 320px;
            padding: 12px;
            border-radius: 8px;
            border: none;
        }

        .welcome-input button {
            padding: 12px 16px;
            border-radius: 8px;
            border: none;
            background: #4c5cff;
            color: white;
            cursor: pointer;
        }


        .tools {
            width: 360px;
            flex-shrink: 0;
            border-left: 1px solid #1d2350;
            background: #0f1326;
            display: none;
            flex-direction: column;
        }

        .tool-grid {
            padding: 16px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .tools {
            width: 360px;
            flex-shrink: 0;
            border-left: 1px solid #1d2350;
            background: #0f1326;
            display: flex;
            flex-direction: column;
        }

        .tool-panel {
            flex: 1;
            padding: 16px;
            border-top: 1px solid #1d2350;
            font-size: 14px;
        }


        .command-palette {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .command-box {
            background: #0f1326;
            width: 420px;
            border-radius: 10px;
            padding: 12px;
        }

        .command {
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .command:hover {
            background: #1d2350;
        }


        .image-gallery {
            width: 260px;
            background: #0f1326;
            border-right: 1px solid #1d2350;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .image-gallery h3 {
            padding: 16px;
            margin: 0;
            border-bottom: 1px solid #1d2350;
            font-size: 14px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
        }

        .gallery-item {
            aspect-ratio: 1;
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .gallery-item:hover {
            border-color: #4c5cff;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }


        #boot-loader {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 10000;
            color: #c7c7c7;
            font-family: "DejaVu Sans Mono", Consolas, monospace;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            padding: 14px;
            display: flex;
            flex-direction: column;
        }

        #boot {
            white-space: pre-wrap;
            height: 100%;
            overflow-y: auto;
        }

        #boot .ok {
            color: #4caf50;
        }

        #boot .warn {
            color: #ffb300;
        }

        #boot .fail {
            color: #f44336;
        }

        .flicker {
            animation: flickerScreen 0.08s infinite;
        }

        @keyframes flickerScreen {
            0% {
                opacity: 1;
            }

            25% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            75% {
                opacity: 0.8;
            }

            100% {
                opacity: 1;
            }
        }

        #app-content {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: row;
        }

        #flash-overlay {
            position: fixed;
            inset: 0;
            background: #fff;
            opacity: 0;
            z-index: 11000;
            pointer-events: none;
        }


        .agreement-container {
            max-width: 600px;
            margin: 40px auto;
            background: #0f1326;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #1d2350;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .agreement-text {
            line-height: 1.6;
            opacity: 0.9;
            margin-bottom: 24px;
        }

        .agreement-checkbox {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding: 12px;
            background: #151a3a;
            border-radius: 8px;
            cursor: pointer;
        }

        #agreementTab {
            color: #ffb300;
            font-weight: 600;
        }

        .disclaimer {
            position: fixed;
            bottom: 12px;
            left: 12px;
            font-size: 10px;
            color: #e8e9f1;
            opacity: 0.5;
            z-index: 1000;
            max-width: 230px;
            pointer-events: none;
            line-height: 1.4;
        }
    </style>
</head>

<body>

    <div id="flash-overlay"></div>

    <div id="boot-loader">
        <div id="boot"></div>
    </div>

    <div id="app-content">
        <div class="sidebar">
            <div class="logo-container">
                <button href="https://gpsite.github.io/gp">Home</button>
                <div class="logo">
                    Clanker Workspace
                    <div class="version">v1.1.3</div>
                </div>
            </div>


            <div id="sidebarChatView">
                <button class="new-chat" onclick="createChat()">+ New Chat</button>
                <div class="chat-list" id="chatList"></div>
            </div>


            <div id="sidebarGalleryView" style="display:none; height:100%; overflow-y:auto;">
                <button class="new-chat" onclick="createNewImage()" style="margin:12px;">+ New Image</button>
                <div class="gallery-grid" id="galleryGrid" style="padding:12px;">

                </div>
            </div>
        </div>

        <div class="main">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chat')">Chat</div>
                <div class="tab" onclick="switchTab('image')">Image</div>
                <div class="tab" onclick="switchTab('settings')">Settings</div>
                <div class="tab" id="agreementTab" onclick="switchTab('agreement')">Agreement</div>
            </div>

            <div class="workspace">

                <div class="panel active" id="chat">
                    <div class="welcome" id="welcome">
                        <h1>Welcome</h1>
                        <p>Start a new conversation by asking anything.</p>
                        <div class="welcome-input">
                            <input id="welcomeInput" placeholder="Ask me anything..." />
                            <button onclick="sendFirstMessage()">Send</button>
                        </div>
                    </div>

                    <div class="messages" id="messages"></div>

                    <div class="input-area" id="chatInput">
                        <input id="input" placeholder="Type a message..." />
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>

                <div class="panel" id="image">

                    <div class="welcome" id="imageWelcome">
                        <h1>Image Generator</h1>
                        <p>Describe the image you want to create.</p>
                        <div class="welcome-input">
                            <input id="imageWelcomeInput" placeholder="Describe your image..."
                                onkeydown="if(event.key==='Enter') sendFirstImage()" />
                            <button onclick="sendFirstImage()">Generate</button>
                        </div>
                    </div>

                    <div id="imagePanel"
                        style="padding:16px; flex:1; overflow-y:auto; display:none; align-items:center; justify-content:center; flex-direction:column;">

                    </div>

                    <div id="imageInputArea"
                        style="padding:16px; display:none; gap:8px; border-top: 1px solid #1d2350;">
                        <input id="imagePrompt" placeholder="Describe your image..."
                            style="flex:1; padding:10px; border-radius:6px; border:none;">
                        <button onclick="sendImagePrompt()"
                            style="padding:10px 16px; border:none; border-radius:6px; background:#4c5cff; color:white; cursor:pointer;">Generate</button>
                    </div>
                </div>

                <div class="panel" id="settings" style="padding:16px; overflow-y:auto;">

                    <h2>AI Settings</h2>

                    <form id="aiSettingsForm">

                        <fieldset>
                            <legend>General</legend>

                            <label>
                                <input type="checkbox" id="aiEnabled" checked>
                                Enable AI
                            </label>
                            <br><br>

                            <label>
                                AI Model:
                                <select id="aiModel">
                                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash‑Lite (Stable)</option>
                                    <option value="gemini-2.5-flash-lite-preview-09-2025">Gemini 2.5 Flash-Preview
                                    </option>
                                    <option value="gemini-flash-latest">Gemini Flash-Latest</option>
                                    <option value="mistral-large-2512">Mistral Large 3</option>
                                    <option value="mistral-medium-2508">Mistral Medium 3.1</option>
                                    <option value="mistral-small-2506">Mistral Small 3.2</option>
                                </select>
                            </label>
                        </fieldset>

                        <br>

                        <fieldset>
                            <legend>API Keys (Optional)</legend>
                            <p style="font-size:12px; opacity:0.7; margin-top:0;">
                                Leave blank to use default keys. Required for custom quotas.
                            </p>

                            <label>
                                Gemini API Key:
                                <input type="password" id="geminiKey" placeholder="AsSYla..."
                                    style="width:100%; margin-top:4px; padding:8px; border:none;">
                            </label>
                            <br><br>

                            <label>
                                Mistral API Key:
                                <input type="password" id="mistralKey" placeholder="Hie9U1..."
                                    style="width:100%; margin-top:4px; padding:8px; border:none;">
                            </label>
                        </fieldset>

                        <br>

                        <fieldset>
                            <legend>Response Behavior</legend>

                            <label>
                                Creativity (Temperature):
                                <input type="range" id="temperature" min="0" max="1" step="0.05" value="0.7">
                            </label>
                            <span id="tempValue">0.7</span>
                            <br><br>

                            <label>
                                Max Output Tokens:
                                <input type="number" id="maxTokens" min="50" max="4096" value="500">
                            </label>
                        </fieldset>

                        <br>

                        <fieldset>
                            <legend>System Prompt</legend>

                            <textarea id="systemPrompt" rows="5" cols="50"
                                placeholder="Optional system instruction for the AI..."></textarea>
                        </fieldset>

                        <br>

                        <fieldset>
                            <legend>Image Generation Settings</legend>
                            <label>
                                Image Style:
                                <select id="imageModel">
                                    <option value="flux">Flux (Standard)</option>
                                    <option value="flux-realism">Photo (Realistic)</option>
                                    <option value="flux-anime">Anime / Manga</option>
                                    <option value="flux-3d">3D Render</option>
                                    <option value="turbo">Turbo (Fastest)</option>
                                </select>
                            </label>
                            <br><br>
                            <label>
                                Resolution:
                                <select id="imageResolution">
                                    <option value="512x512">512 x 512</option>
                                    <option value="768x768">768 x 768</option>
                                    <option value="1024x1024" selected>1024 x 1024</option>
                                    <option value="1024x1792">1024 x 1792 (Portrait)</option>
                                    <option value="1792x1024">1792 x 1024 (Landscape)</option>
                                </select>
                            </label>
                            <br><br>
                            <label>
                                <input type="checkbox" id="imageEnhance" checked>
                                AI Enhance Prompt
                            </label>
                            <br><br>
                            <label>
                                Fixed Seed (Optional):
                                <input type="number" id="imageSeed" placeholder="Random"
                                    style="width:100%; margin-top:4px; padding:8px; border:none;">
                            </label>
                        </fieldset>

                        <br>



                        <br>

                        <button type="button" onclick="saveAISettings()">Save Settings</button>
                        <button type="reset">Reset</button>

                    </form>

                </div>

                <div class="tools" id="tools">
                    <div class="tool-grid">
                        <div class="tool" onclick="openTool('Summarizer')">Summarizer</div>
                        <div class="tool" onclick="openTool('Code Helper')">Code Helper</div>
                        <div class="tool" onclick="openTool('Calculator')">Calculator</div>
                        <div class="tool" onclick="openTool('Analyzer')">Analyzer</div>
                    </div>
                    <div class="tool-panel" id="toolPanel">
                        Select a tool
                    </div>


                    <div id="summarizerPanel" style="display:none;">
                        <h1>AI Summarizer</h1>

                        <textarea id="inputText" placeholder="Paste text to summarize..." rows="10"
                            style="width:100%; padding:10px; border-radius:6px; border:none; margin-bottom:15px; font-family:inherit;"></textarea>

                        <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
                            <div style="display:flex; align-items:center; gap:5px;">
                                <label for="summaryLength" style="font-weight:bold;">Length:</label>
                                <select id="summaryLength" style="padding:8px; border-radius:6px; border:none;">
                                    <option value="short">Short</option>
                                    <option value="medium">Medium</option>
                                    <option value="long">Long</option>
                                </select>
                            </div>
                            <button id="summarizeBtn"
                                style="padding:10px 24px; background:#4c5cff; color:white; border:none; border-radius:6px; cursor:pointer; margin-left:auto; font-weight:bold;">Summarize</button>
                        </div>

                        <h2>Summary Output:</h2>
                        <div id="summaryOutput"
                            style="white-space:pre-wrap; background:#151a3a; padding:15px; border-radius:8px; overflow-y:auto; max-height:400px;">
                        </div>
                    </div>


                    <div id="calculatorPanel" style="display:none;">
                        <h1>Advanced Calculator</h1>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input id="calcInput" placeholder="Enter expression (e.g. sin(45 deg) ^ 2)"
                                style="flex:1; padding:10px; border-radius:6px; border:none;">
                            <button id="calcBtn"
                                style="padding:10px; background:#4c5cff; color:white; border:none; border-radius:6px;">=</button>
                        </div>
                        <div id="calcResult"
                            style="font-size:24px; font-weight:bold; margin-bottom:20px; min-height:36px;">
                        </div>

                        <div style="margin-bottom:20px;">
                            <button id="askAiMathBtn"
                                style="padding:8px 12px; background:#1d2350; color:white; border:1px solid #4c5cff; border-radius:6px; cursor:pointer; font-size:12px;">Explain
                                / Solve with AI</button>
                        </div>

                        <div id="calcAiOutput"
                            style="background:#151a3a; padding:15px; border-radius:8px; white-space:pre-wrap; font-family:monospace; min-height:1px; display:none; margin-bottom:20px; overflow-y:auto; max-height:400px;">
                        </div>

                        <h2>Graphing</h2>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input id="graphInput" placeholder="Enter function (e.g. x^2, sin(x))"
                                style="flex:1; padding:10px; border-radius:6px; border:none;">
                            <button id="graphBtn"
                                style="padding:10px; background:#4c5cff; color:white; border:none; border-radius:6px;">Plot</button>
                        </div>

                        <div id="graphContainer" style="background:white; border-radius:8px; width:100%; height:300px;">
                        </div>

                        <div style="margin-top:10px;">
                            <button id="explainGraphBtn"
                                style="padding:8px 12px; background:#1d2350; color:white; border:1px solid #4c5cff; border-radius:6px; cursor:pointer; font-size:12px;">Explain
                                Graph with AI</button>
                        </div>
                    </div>
                </div>


                <div id="codeHelperPanel" style="display:none;">
                    <h1>Code Helper</h1>

                    <textarea id="codeInput" placeholder="Paste your code here..." rows="8"
                        style="width:100%; padding:10px; border-radius:6px; border:none; margin-bottom:10px; font-family:monospace;"></textarea>

                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <select id="codeAction" style="padding:10px; border-radius:6px;">
                            <option value="explain">Explain Code</option>
                            <option value="refactor">Refactor / Improve</option>
                            <option value="debug">Find Bugs</option>
                        </select>
                        <button id="processCodeBtn"
                            style="padding:10px 20px; background:#4c5cff; color:white; border:none; border-radius:6px; cursor:pointer;">Process</button>
                    </div>

                    <div id="codeOutput"
                        style="background:#151a3a; padding:15px; border-radius:8px; white-space:pre-wrap; font-family:monospace; min-height:100px; overflow-y:auto; max-height:500px;">
                    </div>
                </div>


                <div id="analyzerPanel" style="display:none;">
                    <h1>Text Analyzer</h1>

                    <textarea id="analyzeInput" placeholder="Enter text to analyze..." rows="6"
                        style="width:100%; padding:10px; border-radius:6px; border:none; margin-bottom:10px;"></textarea>

                    <button id="analyzeBtn"
                        style="padding:10px 20px; background:#4c5cff; color:white; border:none; border-radius:6px; cursor:pointer; margin-bottom:15px;">Analyze</button>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div style="background:#1d2350; padding:10px; border-radius:6px;">
                            <div style="opacity:0.7; font-size:12px;">Words</div>
                            <div id="wordCount" style="font-size:20px; font-weight:bold;">0</div>
                        </div>
                        <div style="background:#1d2350; padding:10px; border-radius:6px;">
                            <div style="opacity:0.7; font-size:12px;">Characters</div>
                            <div id="charCount" style="font-size:20px; font-weight:bold;">0</div>
                        </div>
                    </div>

                    <h3>AI Analysis</h3>
                    <div id="analysisOutput"
                        style="background:#151a3a; padding:15px; border-radius:8px; white-space:pre-wrap; min-height:60px; font-style:italic; overflow-y:auto; max-height:400px;">
                    </div>
                </div>

                <div class="panel" id="agreement">
                    <div class="agreement-container">
                        <h1>User Agreement & Code of Conduct</h1>
                        <div class="agreement-text">
                            <p>To ensure a safe and ethical environment at GP-Clanker, you must agree to the
                                following terms:</p>
                            <ul>
                                <li>I will not use this AI for academic dishonesty or cheating on school assignments.
                                </li>
                                <li>I will not generate harmful, illegal, or malicious content.</li>
                                <li>I will not use the AI to inject code into GP or any GP related systems.</li>
                                <li>I understand that this workspace is designed for creativity and productivity
                                    enhancement.</li>
                                <li>I will respect the intellectual property of others.</li>
                            </ul>
                        </div>
                        <label class="agreement-checkbox">
                            <input type="checkbox" id="termsCheck">
                            <span>I agree to use GP-Clanker responsibly and ethically.</span>
                        </label>
                        <button onclick="acceptTerms()"
                            style="width:100%; padding:14px; background:#4c5cff; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Confirm
                            and Unlock AI</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="command-palette" id="palette">
        <div class="command-box">
            <div class="command" onclick="createChat()">New Chat</div>
            <div class="command" onclick="switchTab('chat')">Go to Chat</div>
            <div class="command" onclick="switchTab('image')">Go to Image</div>
            <div class="command" onclick="switchTab('settings')">Go to Settings</div>
        </div>
    </div>

    <div class="disclaimer">
        Okay so this was NOT finished in time so expect things to change or be broken. If things are broken please let
        us
        know in the requests form :)
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.sh/@google/generative-ai";


        const bootContainer = document.getElementById("boot");
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        function timestamp() {
            const now = new Date();
            return `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
        }

        async function printLine(text, type = 'info') {
            const span = document.createElement('span');
            if (type !== 'info') span.classList.add(type);
            span.textContent = text + '\n';
            bootContainer.appendChild(span);
            bootContainer.scrollTop = bootContainer.scrollHeight;
            await sleep(2 + Math.random() * 8);
        }

        async function checkSystem(name, func, retries = 2) {
            for (let i = 0; i <= retries; i++) {
                try {
                    const value = await func();
                    await printLine(`${timestamp()} [  OK  ] ${name}: ${value}`, 'ok');
                    return value;
                } catch {
                    if (i < retries) {
                        await printLine(`${timestamp()} [ WARN ] ${name} check failed, retrying...`, 'warn');
                        await sleep(50);
                    } else {
                        await printLine(`${timestamp()} [ FAIL ] ${name}: FAILED`, 'fail');
                    }
                }
            }
        }

        function generateSubsystemLogs() {
            const subsystems = ['AI-Core', 'GPU', 'Network', 'Storage', 'Sensors', 'Input', 'Thermal', 'Clanker-AI'];
            const messages = [];

            subsystems.forEach(sub => {
                const startTime = Math.random() * 500;
                const branches = Math.floor(Math.random() * 3) + 1;

                for (let b = 0; b < branches; b++) {
                    const statusChance = Math.random();
                    let type = 'ok';
                    let status = '[  OK  ]';
                    if (statusChance < 0.05) { type = 'fail'; status = '[ FAIL ]'; }
                    else if (statusChance < 0.15) { type = 'warn'; status = '[ WARN ]'; }

                    messages.push({
                        timeOffset: startTime + b * 100,
                        text: `${timestamp()} ${status} ${sub} module ${b === 0 ? 'initialized' : 'subtask-' + b}`,
                        type
                    });
                }
            });

            messages.sort((a, b) => a.timeOffset - b.timeOffset);
            return messages;
        }

        async function bootSequence() {
            const loaderIframe = document.createElement('iframe');
            loaderIframe.style.display = 'none';
            document.body.appendChild(loaderIframe);
            loaderIframe.contentDocument.open();

            document.body.classList.add('flicker');

            await printLine(`${timestamp()} Booting GPSystem 1.0.0-custom (x86_64)`);
            await printLine(`${timestamp()} Loading ClankerWorkspace AI...`);
            await printLine(`${timestamp()} Command line: BOOT_IMAGE=/clankerworkspace.img root=/dev/gpsystem rw quiet`);

            const nav = navigator;
            await checkSystem('CPU Cores', () => nav.hardwareConcurrency || 1);
            await checkSystem('Memory (GB)', () => nav.deviceMemory || 1);
            await checkSystem('Screen Resolution', () => `${screen.width}x${screen.height}`);
            await checkSystem('Platform', () => nav.platform || 'unknown');
            await checkSystem('User Agent', () => nav.userAgent || 'unknown');
            await checkSystem('Network Type', () => nav.connection?.effectiveType || 'unknown');
            await checkSystem('API Credentials', fetchRemoteKeys);

            const logs = generateSubsystemLogs();
            for (const log of logs) {
                await printLine(log.text, log.type);
            }

            const finalLogs = [
                ":: running early hook [udev]",
                ":: running hook [base]",
                ":: running hook [autodetect]",
                ":: running hook [modconf]",
                ":: running hook [block]",
                "systemd[1]: GPSystem services starting...",
                "systemd[1]: ClankerWorkspace AI core loaded",
                "systemd[1]: AI subsystem ready",
                "systemd[1]: Hostname set to localhost",
                "systemd[1]: Network Manager initialized",
                "systemd[1]: User login management ready",
                "systemd[1]: Reached target Graphical Interface.",
                "",
                "clankerload:"
            ];

            for (let line of finalLogs) {
                await printLine(`${timestamp()} ${line}`, 'info');
            }


            const flash = document.getElementById('flash-overlay');
            await sleep(50);
            flash.style.opacity = '1';
            await sleep(80);

            document.body.classList.remove('flicker');
            document.getElementById('boot-loader').style.display = 'none';
            document.getElementById('app-content').style.display = 'flex';


            flash.style.opacity = '0';

            loaderIframe.contentDocument.close();
            document.body.removeChild(loaderIframe);
        }


        bootSequence();


        const MISTRAL_ENDPOINT = 'https://api.mistral.ai/v1/chat/completions';
        const SECRETS_URL = 'https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/clanker?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M';


        let DEFAULT_MISTRAL_KEY = '';
        let DEFAULT_GEMINI_KEY = '';

        async function fetchRemoteKeys() {
            try {
                const response = await fetch(SECRETS_URL);
                const data = await response.json();
                if (data.values && data.values.length >= 2) {

                    DEFAULT_GEMINI_KEY = data.values[0][1];
                    DEFAULT_MISTRAL_KEY = data.values[1][1];


                    if (!aiSettings.geminiKey) {
                        genAI = new GoogleGenerativeAI(DEFAULT_GEMINI_KEY);
                    }
                    return "Remote secrets synced";
                }
                return "Empty secrets response";
            } catch (e) {
                return "Offline - check settings";
            }
        }


        let aiSettings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
        let maxedOutModels = new Set();

        function getGeminiKey() { return aiSettings.geminiKey || DEFAULT_GEMINI_KEY; }
        function getMistralKey() { return aiSettings.mistralKey || DEFAULT_MISTRAL_KEY; }

        function loadAISettings() {
            document.getElementById('aiEnabled').checked = aiSettings.enabled ?? true;

            const modelSelect = document.getElementById('aiModel');
            updateModelDropdown();


            let defaultModel = aiSettings.model;
            if (!defaultModel || maxedOutModels.has(defaultModel)) {
                for (let option of modelSelect.options) {
                    if (!option.disabled) {
                        defaultModel = option.value;
                        break;
                    }
                }
                aiSettings.model = defaultModel;
                saveAISettings();
            }

            modelSelect.value = defaultModel;
            document.getElementById('temperature').value = aiSettings.temperature ?? 0.7;
            document.getElementById('tempValue').textContent = aiSettings.temperature ?? 0.7;
            document.getElementById('maxTokens').value = aiSettings.maxTokens ?? 500;
            document.getElementById('systemPrompt').value = aiSettings.systemPrompt || '';


            document.getElementById('geminiKey').value = aiSettings.geminiKey || '';
            document.getElementById('mistralKey').value = aiSettings.mistralKey || '';


            document.getElementById('imageModel').value = aiSettings.imageModel || 'flux';
            document.getElementById('imageResolution').value = aiSettings.imageResolution || '1024x1024';
            document.getElementById('imageEnhance').checked = aiSettings.imageEnhance ?? true;
            document.getElementById('imageSeed').value = aiSettings.imageSeed || '';
        }
        function saveAISettings() {
            aiSettings.enabled = document.getElementById('aiEnabled').checked;
            aiSettings.model = document.getElementById('aiModel').value;
            aiSettings.temperature = parseFloat(document.getElementById('temperature').value);
            aiSettings.maxTokens = parseInt(document.getElementById('maxTokens').value, 10);
            aiSettings.systemPrompt = document.getElementById('systemPrompt').value;

            aiSettings.geminiKey = document.getElementById('geminiKey').value.trim();
            aiSettings.mistralKey = document.getElementById('mistralKey').value.trim();

            aiSettings.imageModel = document.getElementById('imageModel').value;
            aiSettings.imageResolution = document.getElementById('imageResolution').value;
            aiSettings.imageEnhance = document.getElementById('imageEnhance').checked;
            aiSettings.imageSeed = document.getElementById('imageSeed').value.trim();

            localStorage.setItem('aiSettings', JSON.stringify(aiSettings));


            genAI = new GoogleGenerativeAI(getGeminiKey());
        }

        let genAI = new GoogleGenerativeAI(getGeminiKey());


        let chats = JSON.parse(localStorage.getItem('chats') || '{}');
        let activeChat = localStorage.getItem('activeChat');

        let chatMemory = JSON.parse(localStorage.getItem('chatMemory') || '{}');

        function getMemory(chatId) {
            return chatMemory[chatId] || {
                summary: '',
                topic: '',
                lastUserMessage: ''
            };
        }

        function saveMemory(chatId, memory) {
            chatMemory[chatId] = memory;
            localStorage.setItem('chatMemory', JSON.stringify(chatMemory));
        }




        function save() {
            localStorage.setItem('chats', JSON.stringify(chats));
            localStorage.setItem('activeChat', activeChat);
        }

        function createChat() {
            const id = Date.now();
            chats[id] = { name: 'New Chat', messages: [] };
            activeChat = id;
            save();
            render();
        }

        function deleteChat(id) {
            delete chats[id];
            activeChat = Object.keys(chats)[0] || null;


            if (!activeChat) {
                createChat();
                return;
            }

            save();
            render();
        }


        if (!activeChat || !chats[activeChat]) {
            createChat();
        } else {
            render();
        }

        async function runMistral(prompt, model) {
            const res = await fetch(MISTRAL_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${getMistralKey()}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model,
                    messages: [
                        ...(aiSettings.systemPrompt
                            ? [{ role: 'system', content: aiSettings.systemPrompt }]
                            : []),
                        { role: 'user', content: prompt }
                    ],
                    temperature: aiSettings.temperature ?? 0.7,
                    max_tokens: aiSettings.maxTokens ?? 500
                })
            });

            if (!res.ok) {
                const err = await res.text();
                throw new Error(err);
            }

            const data = await res.json();
            return data.choices[0].message.content;
        }



        async function sendMessage(passedText) {
            if (!activeChat) return;
            if (!aiSettings.enabled) return;
            if (!aiSettings.agreedToTerms) {
                alert("You must agree to the User Agreement before using AI features.");
                switchTab('agreement');
                return;
            }

            const input = document.getElementById('input');
            let text = passedText ?? input.value.trim();
            if (!text) return;

            if (!passedText) input.value = '';
            chats[activeChat].messages.push({ role: 'user', text });
            updateMemory(activeChat, text);
            if (Math.random() < 0.3) {
                compressMemory(activeChat);
            }
            render();

            const loadingMessage = { role: 'ai', text: '...' };
            chats[activeChat].messages.push(loadingMessage);
            render();

            let modelId = document.getElementById('aiModel').value;

            const memory = getMemory(activeChat);

            const memoryPrompt = memory.summary
                ? `Conversation memory (use only if relevant):\n${memory.summary}\n\n`
                : '';

            const promptText =
                (aiSettings.systemPrompt
                    ? "System: " + aiSettings.systemPrompt + "\n"
                    : "") +
                memoryPrompt +
                text;

            try {
                if (modelId.startsWith('mistral')) {
                    loadingMessage.text = await runMistral(promptText, modelId);
                } else {
                    const model = genAI.getGenerativeModel({ model: modelId });
                    const response = await model.generateContent(promptText, {
                        temperature: aiSettings.temperature ?? 0.7,
                        maxOutputTokens: aiSettings.maxTokens ?? 500
                    });
                    loadingMessage.text = response.response.text();
                }

                save();
                render();
            } catch (err) {
                if (err.message.toLowerCase().includes('quota')) {
                    maxedOutModels.add(modelId);
                    updateModelDropdown();
                    const nextModel = getNextAvailableModel(modelId);
                    if (nextModel) {
                        document.getElementById('aiModel').value = nextModel;
                        aiSettings.model = nextModel;
                        saveAISettings();
                        sendMessage(text);
                        return;
                    }
                }
                loadingMessage.text = 'Error: ' + err.message;
                render();
            }
        }

        function isTopicShift(prev, current) {
            if (!prev) return false;

            const prevWords = new Set(prev.toLowerCase().split(/\W+/));
            const currWords = new Set(current.toLowerCase().split(/\W+/));

            let overlap = 0;
            for (let w of currWords) {
                if (prevWords.has(w)) overlap++;
            }

            return currWords.size > 4 && overlap < 3;
        }

        function updateMemory(chatId, userText) {
            const memory = getMemory(chatId);

            if (isTopicShift(memory.lastUserMessage, userText)) {
                memory.summary = '';
                memory.topic = userText.slice(0, 60);
            } else {
                memory.summary += memory.summary
                    ? ` Then the user said: ${userText}`
                    : `The user is talking about: ${userText}`;
            }


            memory.summary = memory.summary.slice(-600);

            memory.lastUserMessage = userText;
            saveMemory(chatId, memory);
        }

        async function compressMemory(chatId) {
            const memory = getMemory(chatId);
            if (!memory.summary) return;

            try {
                const model = genAI.getGenerativeModel({ model: aiSettings.model });

                const res = await model.generateContent(
                    `Summarize the following conversation memory in 1–2 sentences. 
Focus on the user's intent or topic. Ignore small talk.

Memory:
${memory.summary}`
                );

                memory.summary = res.response.text().slice(0, 400);
                saveMemory(chatId, memory);
            } catch {

            }
        }


        function updateModelDropdown() {
            const select = document.getElementById('aiModel');
            for (let option of select.options) {
                option.disabled = maxedOutModels.has(option.value);
            }
        }

        function getNextAvailableModel(currentModel) {
            const select = document.getElementById('aiModel');
            for (let option of select.options) {
                if (!maxedOutModels.has(option.value) && option.value !== currentModel) {
                    return option.value;
                }
            }
            return null;
        }

        function sendFirstMessage() {
            if (!activeChat) return;
            const input = document.getElementById('welcomeInput');
            const text = input.value.trim();
            if (!text) return;

            chats[activeChat].name = text.slice(0, 30);
            input.value = '';
            render();
            sendMessage(text);
        }


        function render() {
            const list = document.getElementById('chatList');
            const msgs = document.getElementById('messages');
            const welcome = document.getElementById('welcome');
            const chatInput = document.getElementById('chatInput');

            list.innerHTML = '';
            msgs.innerHTML = '';


            Object.keys(chats).forEach(id => {
                const c = document.createElement('div');
                c.className = 'chat-item' + (id == activeChat ? ' active' : '');
                c.innerHTML = `${chats[id].name}<span class='delete-chat' onclick='event.stopPropagation();deleteChat(${id})'>✕</span>`;
                c.onclick = () => { activeChat = id; save(); render(); };
                list.appendChild(c);
            });

            if (activeChat && chats[activeChat]) {
                const hasMessages = chats[activeChat].messages.length > 0;
                welcome.style.display = hasMessages ? 'none' : 'flex';
                msgs.style.display = hasMessages ? 'block' : 'none';
                chatInput.style.visibility = hasMessages ? 'visible' : 'hidden';

                chats[activeChat].messages.forEach(m => {
                    const d = document.createElement('div');
                    d.className = 'message ' + m.role;


                    d.innerHTML = marked.parse(m.text);


                    const paragraphs = d.querySelectorAll("p");
                    paragraphs.forEach(p => {
                        let text = p.textContent.trim();


                        const displayMathCommands = ["\\frac", "\\sum", "\\int", "\\lim", "\\prod", "\\big", "\\left", "\\right"];
                        const hasDisplayMath = displayMathCommands.some(cmd => text.includes(cmd)) || text.includes("\n");


                        const alreadyWrapped = text.startsWith("$$") && text.endsWith("$$");

                        if (hasDisplayMath && !alreadyWrapped) {
                            p.textContent = `$$${text}$$`;
                        } else if (!alreadyWrapped) {

                            p.textContent = text;
                        }
                    });


                    renderMathInElement(d, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false },
                            { left: "\\(", right: "\\)", display: false },
                            { left: "\\[", right: "\\]", display: true }
                        ],
                        throwOnError: false
                    });

                    msgs.appendChild(d);
                });

                msgs.scrollTop = msgs.scrollHeight;
            }
        }





        const DB_NAME = 'GPClankerStorage';
        const STORE_NAME = 'images';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveImageToGallery(blob, prompt) {
            try {
                const db = await initDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                store.add({
                    data: blob,
                    prompt: prompt,
                    timestamp: Date.now()
                });

                transaction.oncomplete = () => {
                    renderGallery();
                };
            } catch (err) {
                console.error('Local storage error:', err);
            }
        }

        async function renderGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            if (!galleryGrid) return;

            const db = await initDB();
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => {
                const images = request.result.sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);
                galleryGrid.innerHTML = '';

                images.forEach((item) => {
                    const galleryItem = document.createElement('div');
                    galleryItem.className = 'gallery-item';
                    galleryItem.title = item.prompt;

                    const localUrl = URL.createObjectURL(item.data);
                    const img = document.createElement('img');
                    img.src = localUrl;
                    img.alt = item.prompt;

                    galleryItem.onclick = () => {
                        const imagePanel = document.getElementById('imagePanel');
                        document.getElementById('imageWelcome').style.display = 'none';
                        document.getElementById('imageInputArea').style.display = 'none';
                        imagePanel.style.display = 'flex';
                        imagePanel.innerHTML = '';

                        const fullImg = document.createElement('img');
                        fullImg.src = localUrl;
                        fullImg.style.maxWidth = '100%';
                        fullImg.style.borderRadius = '8px';
                        imagePanel.appendChild(fullImg);

                        const promptDiv = document.createElement('div');
                        promptDiv.style.marginTop = '12px';
                        promptDiv.style.padding = '12px';
                        promptDiv.style.background = '#1d2350';
                        promptDiv.style.borderRadius = '6px';
                        promptDiv.style.fontSize = '13px';
                        promptDiv.textContent = `Prompt: ${item.prompt}`;
                        imagePanel.appendChild(promptDiv);
                    };

                    galleryItem.appendChild(img);
                    galleryGrid.appendChild(galleryItem);
                });
            };
        }

        async function generateImage(prompt) {
            const imagePanel = document.getElementById('imagePanel');
            imagePanel.style.display = 'flex';
            imagePanel.innerHTML = '<p>Establishing local data pipe... (fetching binary data)</p>';

            try {
                const modelValue = document.getElementById('imageModel').value || 'flux';
                const resolution = document.getElementById('imageResolution').value || '1024x1024';
                const [width, height] = resolution.split('x');
                const enhance = document.getElementById('imageEnhance').checked;
                const fixedSeed = document.getElementById('imageSeed').value.trim();
                const seed = fixedSeed || Math.floor(Math.random() * 1000000000);

                const encodedPrompt = encodeURIComponent(prompt);
                const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&model=${modelValue}&nologo=true&enhance=${enhance}&seed=${seed}`;

                const response = await fetch(imageUrl);
                if (!response.ok) throw new Error('Network refused the request. (Source domain might be blocked)');

                const blob = await response.blob();
                const localUrl = URL.createObjectURL(blob);

                const img = new Image();
                img.style.maxWidth = '100%';
                img.style.borderRadius = '8px';
                img.src = localUrl;

                imagePanel.innerHTML = '';
                imagePanel.appendChild(img);

                await saveImageToGallery(blob, prompt);

            } catch (err) {
                console.error('Image generation error:', err);
                imagePanel.innerHTML = '<p>Error: ' + err.message + '</p>';
            }
        }

        function createNewImage() {
            document.getElementById('imageWelcome').style.display = 'flex';
            document.getElementById('imagePanel').style.display = 'none';
            document.getElementById('imageInputArea').style.display = 'none';
            document.getElementById('imageWelcomeInput').value = '';
            document.getElementById('imageWelcomeInput').focus();
        }

        function sendFirstImage() {
            if (!aiSettings.agreedToTerms) {
                alert("You must agree to the User Agreement before using AI features.");
                switchTab('agreement');
                return;
            }
            const input = document.getElementById('imageWelcomeInput');
            const prompt = input.value.trim();
            if (prompt) {
                document.getElementById('imageWelcome').style.display = 'none';
                generateImage(prompt);
            }
        }

        function sendImagePrompt() {
            if (!aiSettings.agreedToTerms) {
                alert("You must agree to the User Agreement before using AI features.");
                switchTab('agreement');
                return;
            }
            const prompt = document.getElementById('imagePrompt').value.trim();
            if (prompt) {
                document.getElementById('imageInputArea').style.display = 'none';
                generateImage(prompt);
            }
        }


        renderGallery();


        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            const selectedTab = document.querySelector(`.tab[onclick*="${tab}"]`);
            if (selectedTab) selectedTab.classList.add('active');

            const panel = document.getElementById(tab);
            if (panel) panel.classList.add('active');


            const chatView = document.getElementById('sidebarChatView');
            const galleryView = document.getElementById('sidebarGalleryView');

            if (tab === 'image') {
                chatView.style.display = 'none';
                galleryView.style.display = 'block';
            } else {
                chatView.style.display = 'block';
                galleryView.style.display = 'none';
            }
        }

        function acceptTerms() {
            if (document.getElementById('termsCheck').checked) {
                aiSettings.agreedToTerms = true;
                saveAISettings();
                document.getElementById('agreementTab').style.display = 'none';
                switchTab('chat');
                alert("Agreement confirmed. AI features unlocked!");
            } else {
                alert("Please check the box to agree to the terms.");
            }
        }

        function openTool(name) {
            if (!aiSettings.agreedToTerms) {
                alert("You must agree to the User Agreement before using Tools.");
                switchTab('agreement');
                return;
            }
            const panel = document.getElementById('toolPanel');
            panel.innerHTML = '';

            if (name === 'Summarizer') {

                const template = document.getElementById('summarizerPanel');
                const clone = template.cloneNode(true);
                clone.style.display = 'block';
                panel.appendChild(clone);


                const summarizeBtn = clone.querySelector('#summarizeBtn');
                summarizeBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const text = clone.querySelector('#inputText').value.trim();
                    const length = clone.querySelector('#summaryLength').value;
                    const outputDiv = clone.querySelector('#summaryOutput');

                    if (!text) return;
                    outputDiv.textContent = 'Summarizing...';

                    try {
                        const modelId = document.getElementById('aiModel').value;
                        const prompt = `Summarize the following text in a ${length} summary:\n\n${text}`;

                        let responseText;
                        if (modelId.startsWith('mistral')) {
                            responseText = await runMistral(prompt, modelId);
                        } else {
                            const model = genAI.getGenerativeModel({ model: modelId });
                            const response = await model.generateContent(prompt, {
                                temperature: aiSettings.temperature ?? 0.7,
                                maxOutputTokens: aiSettings.maxTokens ?? 500
                            });
                            responseText = response.response.text();
                        }

                        outputDiv.innerHTML = marked.parse(responseText);
                    } catch (err) {
                        outputDiv.textContent = 'Error: ' + err.message;
                    }
                });
            } else if (name === 'Calculator') {
                const template = document.getElementById('calculatorPanel');
                const clone = template.cloneNode(true);
                clone.style.display = 'block';
                panel.appendChild(clone);

                const calcBtn = clone.querySelector('#calcBtn');
                const graphBtn = clone.querySelector('#graphBtn');


                calcBtn.onclick = () => {
                    const expr = clone.querySelector('#calcInput').value;
                    try {
                        const res = math.evaluate(expr);
                        clone.querySelector('#calcResult').textContent = '= ' + res;
                    } catch (e) {
                        clone.querySelector('#calcResult').textContent = 'Error';
                    }
                };


                graphBtn.onclick = () => {
                    const fn = clone.querySelector('#graphInput').value.trim();
                    try {
                        functionPlot({
                            target: clone.querySelector('#graphContainer'),
                            width: 320,
                            height: 300,
                            grid: true,
                            data: [{ fn: fn || 'sin(x)' }]
                        });
                    } catch (e) {
                        alert('Invalid function for plotting');
                    }
                };


                const aiOutput = clone.querySelector('#calcAiOutput');

                clone.querySelector('#askAiMathBtn').onclick = async () => {
                    const expr = clone.querySelector('#calcInput').value.trim();
                    if (!expr) return;

                    aiOutput.style.display = 'block';
                    aiOutput.textContent = 'Thinking...';

                    const prompt = `Solve or explain this math problem step-by-step:\n\n${expr}`;
                    try {
                        const modelId = document.getElementById('aiModel').value;
                        let responseText;
                        if (modelId.startsWith('mistral')) {
                            responseText = await runMistral(prompt, modelId);
                        } else {
                            const model = genAI.getGenerativeModel({ model: modelId });
                            const result = await model.generateContent(prompt);
                            responseText = result.response.text();
                        }
                        aiOutput.innerHTML = marked.parse(responseText);
                    } catch (e) {
                        aiOutput.textContent = 'Error: ' + e.message;
                    }
                };

                clone.querySelector('#explainGraphBtn').onclick = async () => {
                    const fn = clone.querySelector('#graphInput').value.trim();
                    if (!fn) return;

                    aiOutput.style.display = 'block';
                    aiOutput.textContent = 'Analyzing function...';

                    const prompt = `Explain the properties (domain, range, roots, intercepts, behavior) of this mathematical function:\n\n${fn}`;
                    try {
                        const modelId = document.getElementById('aiModel').value;
                        let responseText;
                        if (modelId.startsWith('mistral')) {
                            responseText = await runMistral(prompt, modelId);
                        } else {
                            const model = genAI.getGenerativeModel({ model: modelId });
                            const result = await model.generateContent(prompt);
                            responseText = result.response.text();
                        }
                        aiOutput.innerHTML = marked.parse(responseText);
                    } catch (e) {
                        aiOutput.textContent = 'Error: ' + e.message;
                    }
                };


            } else if (name === 'Code Helper') {
                const template = document.getElementById('codeHelperPanel');
                const clone = template.cloneNode(true);
                clone.style.display = 'block';
                panel.appendChild(clone);

                clone.querySelector('#processCodeBtn').onclick = async () => {
                    const code = clone.querySelector('#codeInput').value;
                    const action = clone.querySelector('#codeAction').value;
                    const output = clone.querySelector('#codeOutput');

                    if (!code) return;
                    output.textContent = 'Processing...';

                    const prompt = `Act as an expert developer. \n\nGoal: ${action.toUpperCase()}\n\nCode:\n${code}\n\nProvide the output in markdown.`;

                    try {
                        const modelId = document.getElementById('aiModel').value;
                        let responseText;

                        if (modelId.startsWith('mistral')) {
                            responseText = await runMistral(prompt, modelId);
                        } else {
                            const model = genAI.getGenerativeModel({ model: modelId });
                            const result = await model.generateContent(prompt);
                            responseText = result.response.text();
                        }
                        output.innerHTML = marked.parse(responseText);
                    } catch (e) {
                        output.textContent = 'Error: ' + e.message;
                    }
                };

            } else if (name === 'Analyzer') {
                const template = document.getElementById('analyzerPanel');
                const clone = template.cloneNode(true);
                clone.style.display = 'block';
                panel.appendChild(clone);

                clone.querySelector('#analyzeBtn').onclick = async () => {
                    const text = clone.querySelector('#analyzeInput').value.trim();
                    if (!text) return;


                    clone.querySelector('#wordCount').textContent = text.split(/\s+/).filter(w => w).length;
                    clone.querySelector('#charCount').textContent = text.length;

                    const output = clone.querySelector('#analysisOutput');
                    output.textContent = 'Analyzing sentiment...';

                    try {
                        const modelId = document.getElementById('aiModel').value;
                        const prompt = `Analyze the tone and sentiment of this text briefly:\n\n"${text}"`;

                        let responseText;
                        if (modelId.startsWith('mistral')) {
                            responseText = await runMistral(prompt, modelId);
                        } else {
                            const model = genAI.getGenerativeModel({ model: modelId });
                            const result = await model.generateContent(prompt);
                            responseText = result.response.text();
                        }
                        output.innerHTML = marked.parse(responseText);
                    } catch (e) {
                        output.textContent = 'Error: ' + e.message;
                    }
                };

            } else {
                panel.textContent = name + ' panel (under construction)';
            }
        }


        document.getElementById('temperature').addEventListener('input', e => {
            document.getElementById('tempValue').textContent = e.target.value;
        });

        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('palette').style.display = 'flex';
            }
            if (e.key === 'Escape') document.getElementById('palette').style.display = 'none';
            if (e.key === 'Enter') {
                if (document.activeElement.id === 'input') sendMessage();
                if (document.activeElement.id === 'welcomeInput') sendFirstMessage();
                if (document.activeElement.id === 'imageWelcomeInput') sendFirstImage();
                if (document.activeElement.id === 'imagePrompt') sendImagePrompt();
            }
        });


        loadAISettings();
        if (!activeChat) createChat();


        if (aiSettings.agreedToTerms) {
            document.getElementById('agreementTab').style.display = 'none';
        } else {

            switchTab('agreement');
        }

        render();


        window.createChat = createChat;
        window.deleteChat = deleteChat;
        window.switchTab = switchTab;
        window.sendFirstMessage = sendFirstMessage;
        window.sendMessage = sendMessage;
        window.sendFirstImage = sendFirstImage;
        window.sendImagePrompt = sendImagePrompt;
        window.createNewImage = createNewImage;
        window.saveAISettings = saveAISettings;
        window.openTool = openTool;
        window.acceptTerms = acceptTerms;

    </script>

</body>

</html>
